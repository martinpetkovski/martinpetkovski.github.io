<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Македонска Музичка Топ Листа</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&family=Montserrat:wght@600;700&family=Bungee&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="desktop.css" media="screen and (min-width: 601px)">
    <link rel="stylesheet" href="mobile.css" media="screen and (max-width: 600px)">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body.chart-page {
            overflow: hidden;
            height: 100vh;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chart-container {
            max-width: 100%;
            padding: 0.75rem 1rem;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0 0.25rem;
        }
        
        .chart-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .chart-header h1 i { color: var(--accent-orange); font-size: 0.8rem; }
        
        .chart-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .cache-info {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        
        .chart-sections {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            flex: 1;
            min-height: 0;
        }
        
        .chart-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .chart-section-header {
            background: linear-gradient(135deg, #fa5252, #fd7e14);
            color: #fff;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.15);
        }
        
        .chart-section-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .chart-section-header h2 i { font-size: 0.75rem; }
        
        .chart-section-header .period {
            font-size: 0.65rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .chart-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .share-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 4px;
            color: #fff;
            padding: 0.2rem 0.4rem;
            font-size: 0.55rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            transition: background 0.15s ease, transform 0.15s ease;
        }
        
        .share-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }
        
        .share-btn:active {
            transform: scale(0.95);
        }
        
        .share-btn i {
            font-size: 0.5rem;
        }
        
        .share-btn.sharing {
            pointer-events: none;
            opacity: 0.7;
        }
        
        /* Share modal/preview */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-modal-content {
            background: var(--bg-primary);
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }
        
        .share-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .share-modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .share-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .share-modal-close:hover {
            color: var(--text-primary);
        }
        
        .share-preview {
            padding: 1rem;
            display: flex;
            justify-content: center;
        }
        
        .share-preview img {
            max-width: 100%;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .share-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .share-action-btn {
            background: var(--accent-green);
            border: none;
            border-radius: 4px;
            color: #fff;
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: background 0.15s ease, transform 0.15s ease;
        }
        
        .share-action-btn:hover {
            transform: scale(1.02);
        }
        
        .share-action-btn.download {
            background: var(--accent-blue);
        }
        
        .share-action-btn.copy {
            background: var(--accent-purple);
        }
        
        /* Shareable chart card (hidden, used for rendering) */
        .share-card {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 420px;
            background: #fff;
            padding: 0;
            border-radius: 8px;
            font-family: 'Source Sans Pro', sans-serif;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .share-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #fa5252, #fd7e14);
        }
        
        .share-card-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .share-card-title i {
            font-size: 0.9rem;
        }
        
        .share-card-branding {
            font-size: 0.55rem;
            color: rgba(255,255,255,0.85);
            text-align: right;
            line-height: 1.3;
        }
        
        .share-card-branding .mmm {
            font-family: 'Bungee', sans-serif;
            font-size: 0.8rem;
            background: linear-gradient(135deg, #fa5252, #fd7e14);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: #fff;
            display: block;
            margin-bottom: 2px;
        }
        
        .share-card-list {
            list-style: none;
            padding: 0.5rem 0;
            margin: 0;
            background: #fff;
        }
        
        .share-card-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            gap: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        
        .share-card-item:last-child {
            border-bottom: none;
        }
        
        .share-card-item:nth-child(1) {
            background: linear-gradient(90deg, rgba(255,215,0,0.15) 0%, transparent 100%);
        }
        
        .share-card-item:nth-child(2) {
            background: linear-gradient(90deg, rgba(192,192,192,0.12) 0%, transparent 100%);
        }
        
        .share-card-item:nth-child(3) {
            background: linear-gradient(90deg, rgba(205,127,50,0.12) 0%, transparent 100%);
        }
        
        .share-card-rank {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            width: 24px;
            text-align: right;
            color: #999;
        }
        
        .share-card-rank.gold { color: #d4a000; }
        .share-card-rank.silver { color: #888; }
        .share-card-rank.bronze { color: #a06020; }
        
        .share-card-cover {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f0f0f0;
        }
        
        .share-card-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .share-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .share-card-song {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1a1a1a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .share-card-artist {
            font-size: 0.75rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .share-card-footer {
            padding: 0.6rem 1rem;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #eee;
        }
        
        .share-card-date {
            font-size: 0.65rem;
            color: #888;
        }
        
        .share-card-url {
            font-size: 0.6rem;
            color: #aaa;
        }
        
        .chart-list-wrapper {
            position: relative;
            flex: 1;
            min-height: 0;
        }
        
        .chart-list-wrapper::before,
        .chart-list-wrapper::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 20px;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chart-list-wrapper::before {
            top: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 100%);
        }
        
        .chart-list-wrapper::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.3) 0%, transparent 100%);
        }
        
        .chart-list-wrapper.scroll-top::before { opacity: 1; }
        .chart-list-wrapper.scroll-bottom::after { opacity: 1; }
        
        .chart-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: none;
            height: 100%;
            overflow-y: auto;
        }
        
        .chart-list::-webkit-scrollbar { width: 4px; }
        .chart-list::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .chart-list::-webkit-scrollbar-thumb { background: var(--border-color); }
        
        .chart-item {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.75rem 0.4rem 0.4rem;
            border-bottom: 1px solid var(--border-color);
            gap: 0.35rem;
            transition: background 0.15s ease;
        }
        
        .chart-item:last-child { border-bottom: none; }
        .chart-item:hover { background: var(--bg-hover); }
        
        .chart-rank {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            width: 18px;
            text-align: right;
            flex-shrink: 0;
            color: var(--text-muted);
        }
        
        .chart-rank.gold { color: #FFD700; }
        .chart-rank.silver { color: #C0C0C0; }
        .chart-rank.bronze { color: #CD7F32; }
        
        .chart-item.rank-1 { background: linear-gradient(90deg, rgba(255,215,0,0.08) 0%, transparent 100%); }
        .chart-item.rank-2 { background: linear-gradient(90deg, rgba(192,192,192,0.08) 0%, transparent 100%); }
        .chart-item.rank-3 { background: linear-gradient(90deg, rgba(205,127,50,0.08) 0%, transparent 100%); }
        
        .chart-cover {
            width: 36px;
            height: 36px;
            border-radius: 3px;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-secondary);
        }
        
        .chart-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chart-cover .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1DB954, #191414);
            color: rgba(255,255,255,0.5);
            font-size: 0.7rem;
        }
        
        .chart-info {
            flex: 1;
            min-width: 0;
        }
        
        .chart-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }
        
        .chart-artist {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-release-type {
            display: inline-block;
            font-size: 0.45rem;
            font-weight: 500;
            background: var(--accent-green);
            color: #fff;
            padding: 0.02rem 0.15rem;
            border-radius: 2px;
            margin-left: 0.15rem;
            vertical-align: middle;
        }
        
        .chart-release-type.album { background: var(--accent-purple); }
        .chart-release-type.ep { background: var(--accent-blue); }
        
        /* Chart change indicators */
        .chart-change {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            flex-shrink: 0;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .chart-change.new {
            color: #FFD700;
        }
        
        .chart-change.new i {
            font-size: 0.8rem;
        }
        
        .chart-change.up {
            color: #1DB954;
        }
        
        .chart-change.down {
            color: #e74c3c;
        }
        
        .chart-change.same {
            color: var(--text-muted);
            font-size: 0.6rem;
        }
        
        .chart-change .change-value {
            font-size: 0.65rem;
            margin-left: 2px;
        }
        
        /* Popularity change indicator - superscript style */
        .pop-change {
            font-size: 0.45rem;
            font-weight: 700;
            position: absolute;
            top: -4px;
            right: -2px;
            transform: translateX(100%);
        }
        
        .pop-change.up { color: #1DB954; }
        .pop-change.down { color: #e74c3c; }
        
        /* New entry highlight */
        .chart-item.is-new {
            background: linear-gradient(90deg, rgba(255,215,0,0.06) 0%, transparent 70%);
        }
        
        .chart-item.is-new .chart-title::after {
            content: 'НОВО';
            font-size: 0.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 0.05rem 0.2rem;
            border-radius: 2px;
            margin-left: 0.3rem;
            vertical-align: middle;
        }
        
        .chart-meta {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-shrink: 0;
        }
        
        .chart-stat {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif;
        }
        
        .chart-stat.weeks {
            width: 30px;
            justify-content: flex-end;
            white-space: nowrap;
        }
        
        .chart-stat.followers {
            width: 30px;
            margin-right: 10px;
            justify-content: flex-end;
            color: var(--accent-green);
            position: relative;
        }
        
        .chart-stat i { font-size: 0.65rem; }
        
        /* Play button column */
        .chart-play-col {
            width: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-play-btn {
            background: #1DB954;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.15s ease;
            text-decoration: none;
            flex-shrink: 0;
        }
        
        .chart-play-btn i {
            color: #fff;
            font-size: 8px;
        }
        
        .chart-play-btn:hover {
            transform: scale(1.15);
            background: #1ed760;
        }
        
        .chart-loading, .chart-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.7rem;
        }
        
        .chart-loading i, .chart-empty i {
            font-size: 1rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        
        .back-link:hover { color: var(--accent-blue); }
        
        /* Mobile adjustments */
        @media (max-width: 900px) {
            .chart-sections { grid-template-columns: 1fr; }
            .chart-list { max-height: none; }
        }
        
        @media (max-width: 600px) {
            .chart-container { padding: 0.5rem; }
            .chart-header h1 { font-size: 0.8rem; }
            .chart-item { padding: 0.2rem 0.35rem; }
            .chart-cover { width: 24px; height: 24px; }
        }
        
        /* Spotify embed modal */
        .spotify-embed-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        
        .spotify-embed-modal.active {
            display: flex;
        }
        
        .spotify-embed-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
        }
        
        .spotify-embed-content {
            position: relative;
            width: 90%;
            max-width: 400px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .spotify-embed-close {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #1DB954;
            border: none;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s ease, background 0.15s ease;
        }
        
        .spotify-embed-close:hover {
            transform: scale(1.1);
            background: #1ed760;
        }
        
        #spotify-embed-container iframe {
            border-radius: 8px;
        }
    </style>
</head>
<body class="compact chart-page">
    <header>
        <div class="header-content">
            <div class="logo-title-group">
                <span class="site-logo-text">MMM</span>
                <div class="title-group">
                    <h1>Македонска Музичка Топ Листа</h1>
                    <div class="subtitle-stats">
                        <span>Ажурирано пред <span id="last-updated">...</span></span>
                    </div>
                </div>
            </div>
            <div class="header-buttons">
                <a href="list.html" class="header-btn"><i class="fas fa-list"></i> Листа</a>
                <button id="start-tour-btn" class="header-btn tour-btn"><i class="fas fa-globe"></i> Тура</button>
            </div>
        </div>
    </header>
    
    <div class="chart-container">
        
        <div class="chart-sections">
            <!-- Top Singles -->
            <div class="chart-section" id="singles-section">
                <div class="chart-section-header singles">
                    <h2><i class="fas fa-music"></i> Синглови</h2>
                    <div class="chart-header-right">
                        <span class="period" id="singles-period"></span>
                        <button class="share-btn" onclick="shareChart('singles')" title="Сподели">
                            <i class="fas fa-share-alt"></i> Сподели
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="singles-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="singles-chart" class="chart-list" style="display: none;"></ol>
                    <div id="singles-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема синглови</p>
                    </div>
                </div>
            </div>
            
            <!-- Top Albums -->
            <div class="chart-section" id="albums-section">
                <div class="chart-section-header albums">
                    <h2><i class="fas fa-compact-disc"></i> Албуми</h2>
                    <div class="chart-header-right">
                        <span class="period" id="albums-period"></span>
                        <button class="share-btn" onclick="shareChart('albums')" title="Сподели">
                            <i class="fas fa-share-alt"></i> Сподели
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="albums-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="albums-chart" class="chart-list" style="display: none;"></ol>
                    <div id="albums-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема албуми</p>
                    </div>
                </div>
            </div>
            
            <!-- Latest Releases -->
            <div class="chart-section" id="latest-section">
                <div class="chart-section-header">
                    <h2><i class="fas fa-clock"></i> Најнови</h2>
                    <div class="chart-header-right">
                        <span class="period" id="latest-period"></span>
                        <button class="share-btn" onclick="shareChart('latest')" title="Сподели">
                            <i class="fas fa-share-alt"></i> Сподели
                        </button>
                    </div>
                </div>
                <div class="chart-list-wrapper">
                    <div id="latest-chart-loading" class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Се вчитува...</p>
                    </div>
                    <ol id="latest-chart" class="chart-list" style="display: none;"></ol>
                    <div id="latest-chart-empty" class="chart-empty" style="display: none;">
                        <p>Нема изданија</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <h3 id="share-modal-title">Сподели листа</h3>
                <button class="share-modal-close" onclick="closeShareModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="share-preview" id="share-preview"></div>
            <div class="share-actions">
                <button class="share-action-btn" onclick="shareToNative()" id="native-share-btn">
                    <i class="fas fa-share"></i> Сподели
                </button>
                <button class="share-action-btn download" onclick="downloadShareImage()">
                    <i class="fas fa-download"></i> Преземи
                </button>
                <button class="share-action-btn copy" onclick="copyShareImage()">
                    <i class="fas fa-copy"></i> Копирај
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden container for share card rendering -->
    <div id="share-card-container"></div>
    
    <script>
        // Global state for sharing
        let chartDataStore = {
            singles: [],
            albums: [],
            latest: []
        };
        let currentShareBlob = null;
        let currentShareType = null;
        
        const chartTitles = {
            singles: 'Топ Синглови',
            albums: 'Топ Албуми',
            latest: 'Најнови Изданија'
        };
        
        const chartIcons = {
            singles: 'fa-music',
            albums: 'fa-compact-disc',
            latest: 'fa-clock'
        };
        
        // Share functions
        async function shareChart(chartType) {
            const btn = event.target.closest('.share-btn');
            if (btn) btn.classList.add('sharing');
            
            try {
                const releases = chartDataStore[chartType];
                if (!releases || releases.length === 0) {
                    alert('Нема податоци за споделување');
                    return;
                }
                
                // Create share card
                const canvas = await createShareCard(chartType, releases.slice(0, 10));
                
                // Convert to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                currentShareBlob = blob;
                currentShareType = chartType;
                
                // Show preview modal
                const modal = document.getElementById('share-modal');
                const preview = document.getElementById('share-preview');
                const title = document.getElementById('share-modal-title');
                
                title.textContent = 'Сподели: ' + chartTitles[chartType];
                
                // Create preview image
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                preview.innerHTML = '';
                preview.appendChild(img);
                
                // Check if native share is supported
                const nativeShareBtn = document.getElementById('native-share-btn');
                if (navigator.share && navigator.canShare) {
                    nativeShareBtn.style.display = 'flex';
                } else {
                    nativeShareBtn.style.display = 'none';
                }
                
                modal.classList.add('active');
                
            } catch (err) {
                console.error('Error creating share image:', err);
                alert('Грешка при креирање на сликата');
            } finally {
                if (btn) btn.classList.remove('sharing');
            }
        }
        
        async function createShareCard(chartType, releases) {
            const container = document.getElementById('share-card-container');
            const now = new Date();
            const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
            const dateStr = `${now.getDate()} ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            
            // Preload images to ensure they're available for html2canvas
            const imagePromises = releases.map(release => {
                if (!release.thumbnail) return Promise.resolve(null);
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = release.thumbnail;
                });
            });
            
            await Promise.all(imagePromises);
            
            container.innerHTML = `
                <div class="share-card" id="share-card-render">
                    <div class="share-card-header">
                        <div class="share-card-title">
                            <i class="fas ${chartIcons[chartType]}"></i>
                            ${chartTitles[chartType]}
                        </div>
                        <div class="share-card-branding">
                            <span class="mmm">MMM</span>
                            Македонска Музичка<br>Мастер Листа
                        </div>
                    </div>
                    <ul class="share-card-list">
                        ${releases.map((release, index) => {
                            const rank = index + 1;
                            const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                            return `
                                <li class="share-card-item">
                                    <span class="share-card-rank ${rankClass}">${rank}</span>
                                    <div class="share-card-cover">
                                        ${release.thumbnail 
                                            ? `<img src="${release.thumbnail}" crossorigin="anonymous" alt="">`
                                            : ''
                                        }
                                    </div>
                                    <div class="share-card-info">
                                        <div class="share-card-song">${release.releaseTitle}</div>
                                        <div class="share-card-artist">${release.bandName}</div>
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                    <div class="share-card-footer">
                        <div class="share-card-date">${dateStr}</div>
                        <div class="share-card-url">masterlista.martinpetkovski.com</div>
                    </div>
                </div>
            `;
            
            const card = document.getElementById('share-card-render');
            
            // Use html2canvas to render the card
            const canvas = await html2canvas(card, {
                backgroundColor: null,
                scale: 2,
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            // Clean up
            container.innerHTML = '';
            
            return canvas;
        }
        
        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('active');
            currentShareBlob = null;
            currentShareType = null;
        }
        
        async function shareToNative() {
            if (!currentShareBlob) return;
            
            try {
                const file = new File([currentShareBlob], `mmm-${currentShareType}-chart.png`, { type: 'image/png' });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: chartTitles[currentShareType],
                        text: `${chartTitles[currentShareType]} - Македонска Музичка Мастер Листа`
                    });
                } else {
                    // Fallback to just sharing URL/text
                    await navigator.share({
                        title: chartTitles[currentShareType],
                        text: `${chartTitles[currentShareType]} - Македонска Музичка Мастер Листа`,
                        url: window.location.href
                    });
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share failed:', err);
                }
            }
        }
        
        function downloadShareImage() {
            if (!currentShareBlob) return;
            
            const url = URL.createObjectURL(currentShareBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mmm-${currentShareType}-chart.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function copyShareImage() {
            if (!currentShareBlob) return;
            
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': currentShareBlob
                    })
                ]);
                
                // Show feedback
                const btn = event.target.closest('.share-action-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Копирано!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Не може да се копира. Пробајте да преземете.');
            }
        }
        
        // Close modal on background click
        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('share-modal')) {
                closeShareModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeShareModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => {
            const CHART_DATA_URL = 'chart-data.json';
            const PREVIOUS_DATA_URL = 'https://raw.githubusercontent.com/martinpetkovski/martinpetkovski.github.io/HEAD~1/masterlista/chart-data.json';
            
            const now = new Date();
            const twoMonthsAgo = new Date(now);
            twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
            
            const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
            const periodText = `${monthNames[twoMonthsAgo.getMonth()]} - ${monthNames[now.getMonth()]}`;
            document.getElementById('singles-period').textContent = periodText;
            document.getElementById('albums-period').textContent = periodText;
            document.getElementById('latest-period').textContent = `последни 20`;
            
            // Store previous chart data for comparison
            let previousChartData = null;
            
            function formatDataAge(isoString) {
                if (!isoString) return null;
                const generatedAt = new Date(isoString);
                const ageMs = Date.now() - generatedAt.getTime();
                const hours = Math.floor(ageMs / (60 * 60 * 1000));
                const minutes = Math.floor((ageMs % (60 * 60 * 1000)) / (60 * 1000));
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    return `пред ${days}д`;
                }
                if (hours > 0) return `пред ${hours}ч`;
                return `пред ${minutes}мин`;
            }
            
            function updateDataInfo(generatedAt) {
                const lastUpdated = document.getElementById('last-updated');
                const age = formatDataAge(generatedAt);
                if (lastUpdated) lastUpdated.textContent = age || '...';
            }
            
            // Build a lookup map for previous chart positions
            function buildPreviousChartMap(previousReleases, filterFn, sortFn) {
                if (!previousReleases || previousReleases.length === 0) return {};
                
                const releasesSortedByDate = [...previousReleases].sort((a, b) => 
                    new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
                );
                
                const filtered = releasesSortedByDate.filter(filterFn).slice(0, 20);
                const sorted = [...filtered].sort(sortFn);
                
                const map = {};
                sorted.forEach((release, index) => {
                    map[release.releaseId] = {
                        position: index + 1,
                        popularity: release.popularity || 0
                    };
                });
                return map;
            }
            
            // Scroll shadow detection
            function initScrollShadows() {
                document.querySelectorAll('.chart-list').forEach(list => {
                    const wrapper = list.closest('.chart-list-wrapper');
                    if (!wrapper) return;
                    
                    const updateShadows = () => {
                        const { scrollTop, scrollHeight, clientHeight } = list;
                        wrapper.classList.toggle('scroll-top', scrollTop > 5);
                        wrapper.classList.toggle('scroll-bottom', scrollTop < scrollHeight - clientHeight - 5);
                    };
                    
                    list.addEventListener('scroll', updateShadows);
                    // Initial check after render
                    setTimeout(updateShadows, 100);
                });
            }
            
            async function loadPreviousData() {
                try {
                    // Try to fetch from GitHub's raw content for the previous commit
                    const response = await fetch(PREVIOUS_DATA_URL + '?t=' + Date.now());
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Loaded previous chart data for comparison');
                        return data;
                    }
                } catch (err) {
                    console.log('Could not load previous chart data:', err.message);
                }
                
                // Fallback: try localStorage
                try {
                    const stored = localStorage.getItem('mmm-previous-chart');
                    if (stored) {
                        return JSON.parse(stored);
                    }
                } catch (err) {
                    console.log('No localStorage data available');
                }
                
                return null;
            }
            
            function savePreviousData(data) {
                try {
                    localStorage.setItem('mmm-previous-chart', JSON.stringify({
                        generatedAt: data.generatedAt,
                        releases: data.releases
                    }));
                } catch (err) {
                    console.log('Could not save to localStorage');
                }
            }
            
            async function loadChartData() {
                let releases = [];
                let generatedAt = null;
                
                // Load previous data for comparison
                previousChartData = await loadPreviousData();
                
                try {
                    const response = await fetch(CHART_DATA_URL + '?t=' + Date.now());
                    if (response.ok) {
                        const chartData = await response.json();
                        releases = chartData.releases || [];
                        generatedAt = chartData.generatedAt;
                        console.log('Loaded', releases.length, 'releases from chart-data.json');
                        
                        // Save current data as previous for next time (if different)
                        if (!previousChartData || previousChartData.generatedAt !== generatedAt) {
                            savePreviousData(chartData);
                        }
                    } else {
                        console.warn('chart-data.json returned status:', response.status);
                    }
                } catch (err) {
                    console.warn('Could not load chart-data.json:', err);
                }
                
                if (releases.length === 0) {
                    console.warn('No releases found in chart-data.json');
                }
                
                updateDataInfo(generatedAt);
                document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'none');
                
                // Sort all releases by date (most recent first)
                const releasesSortedByDate = [...releases].sort((a, b) => 
                    new Date(b.releaseDate).getTime() - new Date(a.releaseDate).getTime()
                );
                
                const sortByPopularity = (a, b) => (b.popularity || 0) - (a.popularity || 0);
                
                // Top Singles: 20 most recent singles, then sorted by track popularity
                const singlesFilter = r => r.releaseType === 'single';
                const topSingles = releasesSortedByDate
                    .filter(singlesFilter)
                    .slice(0, 20)
                    .sort(sortByPopularity);
                
                // Top Albums: 20 most recent albums/compilations, then sorted by track popularity
                const albumsFilter = r => r.releaseType === 'album' || r.releaseType === 'compilation';
                const topAlbums = releasesSortedByDate
                    .filter(albumsFilter)
                    .slice(0, 20)
                    .sort(sortByPopularity);
                
                // Latest: 20 most recent releases, sorted by date (newest first)
                const latestReleases = releasesSortedByDate.slice(0, 20);
                
                // Build previous chart maps for comparison
                const prevReleases = previousChartData?.releases || [];
                const prevSinglesMap = buildPreviousChartMap(prevReleases, singlesFilter, sortByPopularity);
                const prevAlbumsMap = buildPreviousChartMap(prevReleases, albumsFilter, sortByPopularity);
                // For latest, we don't track position changes since it's date-sorted
                
                renderChart('singles-chart', topSingles, prevSinglesMap);
                renderChart('albums-chart', topAlbums, prevAlbumsMap);
                renderChart('latest-chart', latestReleases, {}, true);
                
                // Store chart data for sharing
                chartDataStore.singles = topSingles;
                chartDataStore.albums = topAlbums;
                chartDataStore.latest = latestReleases;
                
                // Initialize scroll shadows after rendering
                initScrollShadows();
            }
            
            function renderChart(containerId, releases, previousMap = {}, isDateSorted = false) {
                const container = document.getElementById(containerId);
                const loading = document.getElementById(`${containerId}-loading`);
                const empty = document.getElementById(`${containerId}-empty`);
                
                loading.style.display = 'none';
                
                if (releases.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                container.style.display = 'block';
                container.innerHTML = releases.map((release, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                    let itemClass = rank <= 3 ? `rank-${rank}` : '';
                    
                    const popularity = release.popularity || 0;
                    
                    // Calculate weeks on chart
                    const releaseDate = new Date(release.releaseDate);
                    const now = new Date();
                    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                    const weeksOnChart = Math.max(1, Math.ceil((now - releaseDate) / msPerWeek));
                    
                    // Format release date for display
                    const monthNames = ['Јан', 'Фев', 'Мар', 'Апр', 'Мај', 'Јун', 'Јул', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'];
                    const releaseDateStr = `${releaseDate.getDate()} ${monthNames[releaseDate.getMonth()]}`;
                    
                    // Get Spotify ID for embed
                    const spotifyMatch = (release.topTrackUrl || release.releaseUrl || '').match(/spotify\.com\/(track|album)\/([a-zA-Z0-9]+)/);
                    const spotifyType = spotifyMatch ? spotifyMatch[1] : null;
                    const spotifyId = spotifyMatch ? spotifyMatch[2] : null;
                    
                    // Check for changes from previous chart (skip for date-sorted)
                    let changeIndicator = '';
                    let popChangeIndicator = '';
                    
                    if (!isDateSorted) {
                        const prev = previousMap[release.releaseId];
                        if (!prev) {
                            // New entry
                            itemClass += ' is-new';
                            changeIndicator = `<div class="chart-change new" title="Ново"><i class="fas fa-star"></i></div>`;
                            popChangeIndicator = '';
                        } else {
                            // Position change
                            const posChange = prev.position - rank;
                            if (posChange > 0) {
                                changeIndicator = `<div class="chart-change up" title="Се качи за ${posChange}"><i class="fas fa-caret-up"></i><span class="change-value">${posChange}</span></div>`;
                            } else if (posChange < 0) {
                                changeIndicator = `<div class="chart-change down" title="Падна за ${Math.abs(posChange)}"><i class="fas fa-caret-down"></i><span class="change-value">${Math.abs(posChange)}</span></div>`;
                            } else {
                                changeIndicator = `<div class="chart-change same" title="Без промена"><i class="fas fa-minus"></i></div>`;
                            }
                            
                            // Popularity change - only show if changed
                            const popDiff = popularity - prev.popularity;
                            if (popDiff > 0) {
                                popChangeIndicator = `<span class="pop-change up" title="Зголемена популарност">+${popDiff}</span>`;
                            } else if (popDiff < 0) {
                                popChangeIndicator = `<span class="pop-change down" title="Намалена популарност">${popDiff}</span>`;
                            } else {
                                popChangeIndicator = '';
                            }
                        }
                    }
                    
                    // For date-sorted, show weeks on chart (same as other charts)
                    const metaContent = `<span class="chart-stat weeks" title="Недели на листата">${weeksOnChart}н</span>`;
                    
                    // For date-sorted charts, hide position and change indicators
                    const showPosition = !isDateSorted;
                    
                    return `
                        <li class="chart-item ${itemClass}">
                            ${showPosition ? `<span class="chart-rank ${rankClass}">${rank}</span>` : ''}
                            ${showPosition ? changeIndicator : ''}
                            <div class="chart-cover">
                                ${release.thumbnail 
                                    ? `<img src="${release.thumbnail}" alt="${release.releaseTitle}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'placeholder\\'><i class=\\'fab fa-spotify\\'></i></div>'">`
                                    : '<div class="placeholder"><i class="fab fa-spotify"></i></div>'
                                }
                            </div>
                            <div class="chart-info">
                                <div class="chart-title">${release.releaseTitle}</div>
                                <div class="chart-artist">${release.bandName}</div>
                            </div>
                            <div class="chart-play-col">
                                ${spotifyId 
                                    ? `<button class="chart-play-btn" data-spotify-id="${spotifyId}" data-spotify-type="${spotifyType}" title="Преслушај"><i class="fas fa-play"></i></button>`
                                    : `<a href="${release.topTrackUrl || release.releaseUrl}" target="_blank" class="chart-play-btn" title="Слушај"><i class="fas fa-play"></i></a>`
                                }
                            </div>
                            <div class="chart-meta">
                                ${metaContent}
                                <span class="chart-stat followers" title="Популарност"><i class="fas fa-fire"></i>${popularity}${popChangeIndicator}</span>
                            </div>
                        </li>
                    `;
                }).join('');
                
                // Add click listeners for play buttons
                container.querySelectorAll('.chart-play-btn[data-spotify-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const spotifyId = btn.dataset.spotifyId;
                        const spotifyType = btn.dataset.spotifyType;
                        showSpotifyEmbed(spotifyId, spotifyType);
                    });
                });
            }
            
            // Spotify embed modal functionality
            function showSpotifyEmbed(spotifyId, type = 'track') {
                let modal = document.getElementById('spotify-embed-modal');
                
                if (!modal) {
                    // Create modal if it doesn't exist
                    modal = document.createElement('div');
                    modal.id = 'spotify-embed-modal';
                    modal.className = 'spotify-embed-modal';
                    modal.innerHTML = `
                        <div class="spotify-embed-backdrop"></div>
                        <div class="spotify-embed-content">
                            <button class="spotify-embed-close"><i class="fas fa-times"></i></button>
                            <div id="spotify-embed-container"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Close on backdrop click
                    modal.querySelector('.spotify-embed-backdrop').addEventListener('click', closeSpotifyEmbed);
                    modal.querySelector('.spotify-embed-close').addEventListener('click', closeSpotifyEmbed);
                    
                    // Close on Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.classList.contains('active')) {
                            closeSpotifyEmbed();
                        }
                    });
                }
                
                const container = document.getElementById('spotify-embed-container');
                const embedUrl = `https://open.spotify.com/embed/${type}/${spotifyId}?utm_source=generator&theme=0`;
                
                container.innerHTML = `
                    <iframe 
                        src="${embedUrl}" 
                        width="100%" 
                        height="${type === 'track' ? '152' : '352'}" 
                        frameBorder="0" 
                        allowfullscreen="" 
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        loading="lazy"
                    ></iframe>
                `;
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeSpotifyEmbed() {
                const modal = document.getElementById('spotify-embed-modal');
                const container = document.getElementById('spotify-embed-container');
                
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
                if (container) {
                    container.innerHTML = '';
                }
            }
            
            loadChartData();
            
            // ==================== TOUR FUNCTIONALITY ====================
            const tourSteps = [
                {
                    element: null,
                    title: 'Македонска Музичка Топ Листа',
                    description: 'Преглед на најновите изданија од македонски артисти. Листите се ажурираат автоматски секој ден врз основа на Spotify податоци.',
                    position: 'center'
                },
                {
                    element: '#singles-section',
                    title: 'Синглови',
                    description: 'Најпопуларни синглови од последните два месеци, рангирани според популарност на Spotify.',
                    position: 'right'
                },
                {
                    element: '#albums-section',
                    title: 'Албуми',
                    description: 'Нови албуми и EP изданија од македонски артисти во истиот период.',
                    position: 'left'
                },
                {
                    element: '#latest-section',
                    title: 'Најнови',
                    description: 'Последните 20 изданија подредени по датум на објава - од најново кон најстаро.',
                    position: 'left'
                },
                {
                    element: '.chart-item',
                    title: 'Детали за издание',
                    description: 'Секое издание содржи корица, наслов, артист, датум на објава и популарност. Индикаторите покажуваат промена во рангирањето од претходниот период.',
                    position: 'bottom'
                },
                {
                    element: '.share-btn',
                    title: 'Споделување',
                    description: 'Генерирајте слика од листата за споделување на социјални мрежи.',
                    position: 'bottom'
                },
                {
                    element: '.header-btn:first-child',
                    title: 'База на артисти',
                    description: 'Пристап до комплетната база на македонски музички артисти со филтри и детални информации.',
                    position: 'bottom'
                }
            ];

            let currentTourStep = 0;
            let tourActive = false;

            function initTour() {
                const tourBtn = document.getElementById('start-tour-btn');
                if (!tourBtn) return;

                // Create tour overlay if not exists
                if (!document.getElementById('tour-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.id = 'tour-overlay';
                    overlay.className = 'tour-overlay';
                    overlay.innerHTML = `
                        <div class="tour-highlight"></div>
                        <div class="tour-tooltip">
                            <div class="tour-tooltip-content">
                                <h3 class="tour-title"></h3>
                                <p class="tour-description"></p>
                            </div>
                            <div class="tour-footer">
                                <span class="tour-progress"></span>
                                <div class="tour-buttons">
                                    <button class="tour-btn-skip">Прескокни</button>
                                    <button class="tour-btn-prev"><i class="fas fa-arrow-left"></i></button>
                                    <button class="tour-btn-next">Следно <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                const overlay = document.getElementById('tour-overlay');
                const tooltip = overlay.querySelector('.tour-tooltip');
                const prevBtn = tooltip.querySelector('.tour-btn-prev');
                const nextBtn = tooltip.querySelector('.tour-btn-next');
                const skipBtn = tooltip.querySelector('.tour-btn-skip');

                tourBtn.addEventListener('click', startTour);
                prevBtn.addEventListener('click', prevStep);
                nextBtn.addEventListener('click', nextStep);
                skipBtn.addEventListener('click', endTour);

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay || e.target.classList.contains('tour-highlight')) {
                        endTour();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (!tourActive) return;
                    if (e.key === 'Escape') endTour();
                    if (e.key === 'ArrowRight' || e.key === 'Enter') nextStep();
                    if (e.key === 'ArrowLeft') prevStep();
                });
            }

            function startTour() {
                tourActive = true;
                currentTourStep = 0;
                document.getElementById('tour-overlay').classList.add('active');
                document.body.style.overflow = 'hidden';
                showTourStep(currentTourStep);
            }

            function endTour() {
                tourActive = false;
                document.getElementById('tour-overlay').classList.remove('active');
                document.body.style.overflow = '';
            }

            function prevStep() {
                if (currentTourStep > 0) {
                    currentTourStep--;
                    showTourStep(currentTourStep);
                }
            }

            function nextStep() {
                if (currentTourStep < tourSteps.length - 1) {
                    currentTourStep++;
                    showTourStep(currentTourStep);
                } else {
                    endTour();
                }
            }

            function showTourStep(stepIndex) {
                const step = tourSteps[stepIndex];
                const overlay = document.getElementById('tour-overlay');
                const highlight = overlay.querySelector('.tour-highlight');
                const tooltip = overlay.querySelector('.tour-tooltip');
                const titleEl = tooltip.querySelector('.tour-title');
                const descEl = tooltip.querySelector('.tour-description');
                const progressEl = tooltip.querySelector('.tour-progress');
                const prevBtn = tooltip.querySelector('.tour-btn-prev');
                const nextBtn = tooltip.querySelector('.tour-btn-next');

                titleEl.textContent = step.title;
                descEl.innerHTML = step.description;
                progressEl.textContent = `${stepIndex + 1} / ${tourSteps.length}`;

                prevBtn.disabled = stepIndex === 0;
                nextBtn.innerHTML = stepIndex === tourSteps.length - 1 
                    ? 'Заврши <i class="fas fa-check"></i>' 
                    : 'Следно <i class="fas fa-arrow-right"></i>';

                tooltip.classList.remove('arrow-top', 'arrow-bottom', 'arrow-left', 'arrow-right', 'tour-center');

                if (step.position === 'center' || !step.element) {
                    highlight.style.display = 'none';
                    tooltip.classList.add('tour-center');
                    tooltip.style.top = '';
                    tooltip.style.left = '';
                } else {
                    const targetEl = document.querySelector(step.element);
                    if (!targetEl) {
                        if (stepIndex < tourSteps.length - 1) {
                            currentTourStep++;
                            showTourStep(currentTourStep);
                        }
                        return;
                    }

                    setTimeout(() => {
                        positionHighlight(targetEl, highlight);
                        positionTooltip(targetEl, tooltip, step.position);
                    }, 50);
                }
            }

            function positionHighlight(element, highlight) {
                const rect = element.getBoundingClientRect();
                const padding = 4;
                highlight.style.display = 'block';
                highlight.style.top = (rect.top - padding) + 'px';
                highlight.style.left = (rect.left - padding) + 'px';
                highlight.style.width = (rect.width + padding * 2) + 'px';
                highlight.style.height = (rect.height + padding * 2) + 'px';
            }

            function positionTooltip(element, tooltip, position) {
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                const gap = 16;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                if (viewportWidth <= 600) {
                    tooltip.classList.add('arrow-top');
                    return;
                }

                let top, left;
                let arrowClass = '';

                switch (position) {
                    case 'bottom':
                        top = rect.bottom + gap;
                        left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                        arrowClass = 'arrow-top';
                        break;
                    case 'top':
                        top = rect.top - tooltipRect.height - gap;
                        left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                        arrowClass = 'arrow-bottom';
                        break;
                    case 'left':
                        top = rect.top + rect.height / 2 - tooltipRect.height / 2;
                        left = rect.left - tooltipRect.width - gap;
                        arrowClass = 'arrow-right';
                        break;
                    case 'right':
                        top = rect.top + rect.height / 2 - tooltipRect.height / 2;
                        left = rect.right + gap;
                        arrowClass = 'arrow-left';
                        break;
                }

                if (left < 10) left = 10;
                if (left + tooltipRect.width > viewportWidth - 10) left = viewportWidth - tooltipRect.width - 10;
                if (top < 10) top = 10;
                if (top + tooltipRect.height > viewportHeight - 10) top = viewportHeight - tooltipRect.height - 10;

                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.classList.add(arrowClass);
            }

            initTour();
        });
    </script>
</body>
</html>
