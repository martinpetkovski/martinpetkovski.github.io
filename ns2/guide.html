<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NS2 Editor Tutorial</title>
    <link rel="icon" type="image/png" href="icon_transparent.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1E1E1E;
            color: #D4D4D4;
            font-size: 13px;
            height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            background-color: #1E1E1E;
            padding: 5px 10px;
            border-bottom: 1px solid #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 10px;
            height: 40px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 20px;
            color: #D4D4D4;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            margin: 0;
        }

        button {
            padding: 5px 8px;
            background-color: #007bb0;
            color: #FFFFFF;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 12px;
            margin: 0;
        }

            button:hover {
                background-color: #005A9E;
            }

            button:active {
                transform: scale(0.95);
            }

        .tab-content {
            flex-direction: column;
            height: calc(100vh - 40px);
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            display: flex;
            width: 100%;
        }

        .section {
            margin-bottom: 8px;
            background-color: #252526;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            padding: 8px;
            transition: opacity 0.3s ease;
        }

        h2 {
            margin-top: 0;
            font-size: 16px;
            color: #007bb0;
        }

        h3 {
            margin: 16px 0 8px 0;
            font-size: 14px;
            color: #007bb0;
        }

        p {
            margin: 4px 0;
            line-height: 1.4;
        }

        ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        li {
            margin-bottom: 4px;
        }

        a {
            color: #00AbC0;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .back-link {
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="icon_transparent.png" alt="Icon" style="height: 30px; width: auto;">
        <h1>NS2 Editor Tutorial</h1>
    </div>

    <div class="tab-content">
        <div class="section">
            <div class="back-link">
                <a href="index.html"><i class="fas fa-arrow-left"></i> Back to NS2 Editor</a>
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button onclick="copyRaw()">Copy Raw Text</button>
                <button onclick="copyMarkdown()">Copy as Markdown</button>
            </div>
            <div id="guide-content">
                <h1>NS2 Editor Tutorial</h1>
                <p>Welcome to the NS2 Editor! This is a comprehensive, web-based tool designed for creating and editing interactive stories or games in the NS2 format. NS2 is a custom scripting language for narrative-driven experiences, featuring states (like scenes or locations), variables (for tracking player progress or stats), choices (branching decisions), and expressions (for logic and conditions). The editor provides a visual interface to build these elements without always needing to write raw code, though advanced users can edit the underlying NS2 script directly.</p>
                <p>This expanded tutorial now includes details on the intrinsic mechanics of the NS2 format, drawn from the underlying StoryEngine implementation. It covers how the engine parses files, evaluates expressions, handles variables with constraints, processes state properties, and executes gameplay logic. This will help you understand limitations, best practices, and advanced features. The tutorial assumes no prior knowledge but builds progressively. If you're new, follow along step-by-step. The editor runs in your browser and uses local storage for autosaving drafts, but always save your work explicitly.</p>
                <h2>1. Introduction and Setup</h2>
                <h3>What is NS2?</h3>
                <p>NS2 is a format for interactive fiction or choice-based games. Key concepts (expanded with intrinsics):</p>
                <ul>
                    <li><strong>States</strong>: Individual scenes or nodes in the story graph. Each state has a title, description, and optional logic (e.g., scripts, requirements). Intrinsically, states are stored in a map for quick lookup, and the engine marks them as visited unless flagged with "dont_mark_visited". Properties like "start_visited" auto-mark them at game start, and "always_available" allows revisits.</li>
                    <li><strong>Variables</strong>: Trackable values like health, inventory, or flags (e.g., "has_key = true"). Supports types: string (with enum constraints), float (with min/max ranges), bool, and int (treated as float internally). Constraints enforce values during sets.</li>
                    <li><strong>Choices</strong>: Branching options in a state that lead to other states, with conditions (e.g., only show if "health > 0"). Choices can have effects (executed on selection) and a "hide" flag to suppress unavailable options.</li>
                    <li><strong>Expressions</strong>: Used in conditions, effects, or scripts. Intrinsically, the engine supports nested parentheses, quoted strings, logical (and/or/not), comparisons (>=, <=, !=, ==, >, <, =), math (+, -, *, /), and functions (set, reset, visited, get, dice, min, max, abs, sqrt, chance, if). Expressions are evaluated recursively with error handling.</li>
                    <li><strong>Metadata</strong>: Overall story title, description, and starting state.</li>
                    <li><strong>Intrinsics Overview</strong>: The engine uses a REPL-like evaluation for expressions, with RNG for dice/chance (seeded by time). Text processing interpolates [expr] blocks. Play logic checks requirements before transitions and executes actions/scripts on entry.</li>
                </ul>
                <p>The editor compiles these into a playable NS2 file, backed by the StoryEngine C++ implementation.</p>
                <h3>Running the Editor</h3>
                <ul>
                    <li>Open the provided HTML file in a modern browser (Chrome/Firefox recommended).</li>
                    <li>No installation neededâ€”it's self-contained with JavaScript and external libraries (e.g., Monaco Editor for text, Mermaid for graphs).</li>
                    <li>The interface is dark-themed for comfort. Use the Language menu to switch locales (e.g., English, Japanese).</li>
                </ul>
                <h3>Interface Overview</h3>
                <ul>
                    <li><strong>Header</strong>: Logo, title, and menus (File, Edit, Play, Language, Help).</li>
                    <li><strong>Tabs</strong>: Switch between views (Text, Metadata, Variables, States, Graph, Play).</li>
                    <li><strong>Global Toolbar</strong>: Appears below tabs with context-specific buttons (e.g., delete, zoom).</li>
                    <li><strong>Right-Click Menus</strong>: For quick insertions in inputs or graph nodes. Includes tokens like functions (e.g., "dice(1,6)") with examples.</li>
                    <li><strong>Shortcuts</strong>: Ctrl+S (Save), Ctrl+O (Load), Ctrl+N (New), 1-6 (Switch tabs), etc.</li>
                </ul>
                <p>If the editor loads a blank story, create a new one via File > New Story.</p>
                <h2>2. Getting Started</h2>
                <h3>Creating a New Story</h3>
                <ol>
                    <li>Click <strong>File > New Story</strong>.</li>
                    <li>Confirm if prompted (unsaved changes are lost).</li>
                    <li>The editor resets to a blank slate. Switch to the <strong>Metadata</strong> tab to set basics.</li>
                </ol>
                <ul>
                    <li>Intrinsics: This initializes an empty StoryEngine instance with no states or variables.</li>
                </ul>
                <h3>Loading a Story</h3>
                <ol>
                    <li>Click <strong>File > Load Story</strong>.</li>
                    <li>Select an <code>.ns2</code> file from your computer.</li>
                    <li>The story loads into all tabs. If invalid, an alert shows.</li>
                </ol>
                <ul>
                    <li>Intrinsics: The engine parses the file line-by-line, handling UTF-8 BOM, trimming, and switching modes ([variables], [states]). Errors in syntax (e.g., mismatched brackets) may cause partial loads.</li>
                </ul>
                <h3>Saving a Story</h3>
                <ol>
                    <li>Click <strong>File > Save Story</strong>.</li>
                    <li>Downloads as <code>edited.ns2</code>.</li>
                </ol>
                <ul>
                    <li>Tip: The editor autosaves to browser local storage. On reload, it restores the last draft.</li>
                    <li>Intrinsics: Saving generates NS2 content via GenerateNS2(), formatting metadata, variables (with initials and constraints), and states (with all fields).</li>
                </ul>
                <h3>Help and Guides</h3>
                <ul>
                    <li>Click <strong>Help > Guide...</strong> to open <code>guide.html</code> (create this file if needed with your own content).</li>
                    <li><strong>Help > AI...</strong> for AI-related tips (e.g., generating content).</li>
                    <li><strong>Help > About...</strong> for version info.</li>
                </ul>
                <h2>3. Metadata Tab</h2>
                <p>This tab sets the story's high-level info. It's the default view on load.</p>
                <h3>Editing Metadata</h3>
                <ol>
                    <li><strong>Title</strong>: Enter the story's name (e.g., "Quest for the Lost Artifact").</li>
                    <li><strong>Description</strong>: A multi-line summary or intro text.</li>
                    <li><strong>Start</strong>: Select the starting state from the dropdown (populated from states you create later).</li>
                </ol>
                <ul>
                    <li>Changes save automatically.</li>
                    <li>Intrinsics: The engine uses "Start" to set the initial state in Start(). If invalid, play may fail.</li>
                </ul>
                <p>Example:</p>
                <ul>
                    <li>Title: "My Adventure"</li>
                    <li>Description: "A tale of heroes and dragons."</li>
                    <li>Start: "intro" (add this state later).</li>
                </ul>
                <p>Tip: Use the right-click menu on inputs for token suggestions (e.g., variables, functions). Metadata doesn't support expressions intrinsically, but you can reference them in text via [expr] in descriptions elsewhere.</p>
                <h2>4. Variables Tab</h2>
                <p>Variables store dynamic data. Intrinsically, they are stored in maps for types, values, and constraints. The engine enforces constraints on set operations.</p>
                <h3>Supported Variable Types and Intrinsics</h3>
                <ul>
                    <li><strong>string</strong>: Text values. Constraints: Enums (comma-separated list, e.g., "red,blue,green"). On set, snaps to first enum if invalid.</li>
                    <li><strong>int/float</strong>: Numeric (treated as float internally). Constraints: Min,max range (e.g., "0,100"). On set, clamps to range.</li>
                    <li><strong>bool</strong>: True/false. No constraints.</li>
                </ul>
                <p>Variables can be referenced via get(var) in expressions.</p>
                <h3>Adding a Variable</h3>
                <ol>
                    <li>Switch to <strong>Variables</strong> tab.</li>
                    <li>Click the <strong>+</strong> icon in the toolbar.</li>
                    <li>Enter a name (e.g., "health").</li>
                    <li>It appears in the table with defaults.</li>
                </ol>
                <ul>
                    <li>Intrinsics: Adds to VariableList for ordering, sets type to "string" by default.</li>
                </ul>
                <h3>Editing Variables</h3>
                <ul>
                    <li><strong>Type</strong>: Dropdown (string, int, float, bool). Intrinsically, "int" is alias for float.</li>
                    <li><strong>Name</strong>: Unique identifier (e.g., "gold"). Changing renames everywhere.</li>
                    <li><strong>Initial</strong>: Starting value (e.g., "100" for float). For strings, enclose in quotes if needed (handled automatically).</li>
                    <li><strong>Constraint</strong>: Expression or values. For float: "min,max" (e.g., "0,100"). For string: "val1,val2" (e.g., "male,female"). Bool/float without constraints are unbounded.</li>
                    <li>Changes save automatically.</li>
                    <li>Search: Use the top search bar to filter by name.</li>
                    <li>Intrinsics: On play start, initials are set. Use set(get(var) + 1) to increment.</li>
                </ul>
                <h3>Removing a Variable</h3>
                <ul>
                    <li>Click the trash icon next to it.</li>
                    <li>Intrinsics: Removes from all maps; references in expressions will error at runtime.</li>
                </ul>
                <p>Example:</p>
                <ul>
                    <li>Type: float, Name: "score", Initial: "0", Constraint: "0,1000" (clamps values).</li>
                    <li>Type: string, Name: "gender", Initial: "male", Constraint: "male,female" (enforces enum).</li>
                </ul>
                <p>Advanced: Variables humanize in stats (e.g., "has_key" -> "Has Key"). Use in expressions like "if(get(health) > 50, 'strong', 'weak')".</p>
                <h2>5. States Tab</h2>
                <p>States are the core of your story. This tab has a split view: left (list of states), right (details). Intrinsically, states are a map of names to structs with fields.</p>
                <h3>Adding a State</h3>
                <ol>
                    <li>Switch to <strong>States</strong> tab.</li>
                    <li>Click the <strong>+</strong> icon in the left toolbar.</li>
                    <li>Enter a unique name (e.g., "village").</li>
                    <li>It appears in the list. Click to edit details.</li>
                </ol>
                <ul>
                    <li>Intrinsics: Adds empty State{}.</li>
                </ul>
                <h3>Editing State Details</h3>
                <p>Select a state to load its form:</p>
                <ul>
                    <li><strong>Name</strong>: Unique ID (change renames it everywhere).</li>
                    <li><strong>Title</strong>: Display name (e.g., "The Quiet Village"). Supports [expr] interpolation.</li>
                    <li><strong>Description</strong>: Narrative text shown to players (multi-line). Supports [expr] (e.g., "[get(health)] HP left.").</li>
                    <li><strong>Context</strong>: Expression for setup, prefixed to description (e.g., "[if(visited(before), 'You return', 'First time')]").</li>
                    <li><strong>Script</strong>: Code run on enter (e.g., "set(health, get(health) - 1)"). Semicolon-separated statements.</li>
                    <li><strong>Requires</strong>: Semicolon-separated conditions to enter (e.g., "visited(intro); get(level) >= 2"). Evaluated as AND.</li>
                    <li><strong>Actions</strong>: Semicolon-separated effects on enter (e.g., "set(visited_count, get(visited_count) + 1)").</li>
                    <li><strong>Properties</strong>: Semicolon-separated tags (e.g., "start_visited; always_available; dont_mark_visited").</li>
                    <li>Intrinsics: "start_visited" marks at game start; "always_available" allows revisits; "dont_mark_visited" skips marking.</li>
                </ul>
                <p>Changes save automatically.</p>
                <h3>Managing Choices</h3>
                <p>Choices branch the story. Intrinsically, stored as vector of structs.</p>
                <ul>
                    <li>Search: Filter choices by text.</li>
                    <li>Add: Click <strong>+</strong> in the choices toolbar.</li>
                    <li>Edit:</li>
                    <ul>
                        <li><strong>Text</strong>: What the player sees (e.g., "Go to the forest"). Supports [expr].</li>
                        <li><strong>Cond</strong>: Condition to show (e.g., "get(health) > 0"). Empty = always.</li>
                        <li><strong>Target</strong>: State to go to (dropdown of states). Checks requires on advance.</li>
                        <li><strong>Effect</strong>: Semicolon-separated statements on choose (e.g., "set(health, get(health) - 10); reset(some_state)").</li>
                        <li><strong>Hide</strong>: Checkbox to hide if condition fails (vs. show disabled). Intrinsically, "hide" flag.</li>
                    </ul>
                    <li>Remove: Trash icon.</li>
                    <li>Go to Target: Arrow button next to target input.</li>
                    <li>Intrinsics: On play, choices filter by cond and !visited (unless always_available). Effects execute before transition. Engine generates descriptions like "gain 10 Health" for UI.</li>
                </ul>
                <p>Example State: "intro"</p>
                <ul>
                    <li>Title: "Welcome"</li>
                    <li>Description: "You wake up in a forest. [if(get(has_sword), 'With sword', 'Unarmed')]."</li>
                    <li>Script: "set(health, 100)"</li>
                    <li>Requires: ""</li>
                    <li>Actions: "set(visited_intro, true)"</li>
                    <li>Properties: "start_visited"</li>
                    <li>Choices:</li>
                    <ul>
                        <li>Text: "Head north", Cond: "", Target: "village", Effect: "set(steps, get(steps) + 1)", Hide: false.</li>
                    </ul>
                </ul>
                <h3>Toolbar Actions (Global Toolbar)</h3>
                <ul>
                    <li>Trash: Delete selected state.</li>
                    <li>Flag: Set as start state.</li>
                    <li>Play: Jump to in Play tab (if possible, checks CanVisitState).</li>
                    <li>Forward: Force jump (ignores requirements, sets directly).</li>
                    <li>Diagram: View in Graph tab (centered on this state).</li>
                </ul>
                <h3>Filtering States</h3>
                <ul>
                    <li>Use the left search bar to find by title/name.</li>
                </ul>
                <p>Tip: Right-click inputs for tokens (e.g., "visited(state_name)" checks if visited). Use reset(state) in effects to allow revisits.</p>
                <h2>6. Text Tab</h2>
                <p>For advanced users: Edit the raw NS2 script.</p>
                <h3>Using the Text Editor</h3>
                <ol>
                    <li>Switch to <strong>Text</strong> tab.</li>
                    <li>Monaco editor loads with syntax highlighting:</li>
                    <ul>
                        <li>Keywords: [metadata], [variables], [states], etc.</li>
                        <li>Functions: set, get, if, etc.</li>
                        <li>Colors: Dark theme.</li>
                    </ul>
                    <li>Edit freely (e.g., add sections manually).</li>
                    <li>Click the check icon (toolbar) to apply changes.</li>
                    <ul>
                        <li>If invalid, alerts and reverts.</li>
                        <li>Intrinsics: On apply, reloads via LoadFromFile, parsing as described.</li>
                    </ul>
                </ol>
                <p>Example Snippet:</p>
<pre>
[metadata]
title: My Story
description: A test.
start: intro

[variables]
float health: 100 (0,200)
string gender: "male" (male,female)
bool has_sword: false

[states]
[state intro]
title: Start
description: Hello [get(name)]. Health: [get(health)].
context: [if(visited(before), "Returning", "New")]
script: set(health, max(get(health), 50))
requires: visited(start); get(level) >= 1
actions: set(visits, get(visits) + 1)
properties: always_available; dont_mark_visited
- Go on [get(health) > 0] -> village [set(health, get(health) - dice(5,10)); reset(before)] [hide]
</pre>
                <p>Tip: Use word wrap (enabled). Changes here sync to other tabs on apply. Intrinsics: Choices use "- text [cond] -> target [effect] [hide]".</p>
                <h2>7. Graph Tab</h2>
                <p>Visualize state connections as a flowchart.</p>
                <h3>Viewing the Graph</h3>
                <ol>
                    <li>Switch to <strong>Graph</strong> tab.</li>
                    <li>Mermaid renders a diagram:</li>
                    <ul>
                        <li>Nodes: States (title shown).</li>
                        <li>Edges: Choices (labeled with choice text).</li>
                    </ul>
                    <li>If a state is selected (from States tab), it's highlighted and centered.</li>
                    <ul>
                        <li>Intrinsics: Graph built from adjacency (choices targets), including reverse for neighbors.</li>
                    </ul>
                </ol>
                <h3>Interactions</h3>
                <ul>
                    <li>Pan/Zoom: Mouse drag/wheel.</li>
                    <li>Right-Click Node: Context menu > View State (switches to States tab).</li>
                    <li>Toolbar:</li>
                    <ul>
                        <li>Sync: Reset to full graph.</li>
                        <li>+: Zoom in.</li>
                        <li>-: Zoom out.</li>
                        <li>Crosshairs: Center.</li>
                    </ul>
                </ul>
                <p>Shortcuts: +/=, - (zoom), 0 (center), Arrows (pan).</p>
                <p>Tip: For large stories, focus via States tab first.</p>
                <h2>8. Play Tab</h2>
                <p>Test your story interactively. Intrinsically, uses a separate engine instance loaded from current NS2.</p>
                <h3>Starting Play</h3>
                <ol>
                    <li>Switch to <strong>Play</strong> tab.</li>
                    <li>Click Play icon (toolbar) or <strong>Play > Start Play</strong>.</li>
                    <li>Story loads from current editor state.</li>
                    <ul>
                        <li>Title/Description shown (processed with [expr]).</li>
                        <li>Choices: Buttons to advance (filtered by cond, visited).</li>
                        <li>Variables: Editable table (change values for testing).</li>
                        <li>Stats: Player info (humanized, e.g., "You have a Sword.").</li>
                        <li>Error: Any runtime issues (e.g., division by zero).</li>
                        <li>Intrinsics: Calls Start(): sets current to start, marks visited (unless dont_mark), executes actions.</li>
                    </ul>
                </ol>
                <h3>Playing</h3>
                <ul>
                    <li>Click choices to proceed.</li>
                    <ul>
                        <li>Intrinsics: Advance executes effect, checks requires, transitions, marks visited, runs new actions/script.</li>
                    </ul>
                    <li>If ended: Message shown (no available actions).</li>
                    <li>Toolbar:</li>
                    <ul>
                        <li>Play: Restart with current edits.</li>
                        <li>Upload: Load progress (.save file: current state, variables, visited).</li>
                        <li>Download: Save progress.</li>
                        <li>Redo: Restart.</li>
                    </ul>
                </ul>
                <h3>Debugging</h3>
                <ul>
                    <li>Edit variables live (enforces constraints).</li>
                    <li>Search choices/variables.</li>
                    <li>Force jumps from States tab.</li>
                    <li>Intrinsics: Errors from eval (e.g., unknown var) append to LastError, shown in desc.</li>
                </ul>
                <p>Save/Load Progress: For resuming tests.</p>
                <h2>9. Expressions and Tokens</h2>
                <p>Expressions power logic. Intrinsically, recursive evaluation with short-circuiting for and/or.</p>
                <h3>Supported Syntax and Intrinsics</h3>
                <ul>
                    <li><strong>Functions</strong>:</li>
                    <ul>
                        <li>set(var, expr): Sets var (enforces constraints). E.g., set(health, get(health) + 5).</li>
                        <li>reset(state): Unmarks visited, allows revisit.</li>
                        <li>not(expr): Logical not (bool arg).</li>
                        <li>visited(state): True if visited.</li>
                        <li>get(var): Gets value (typed).</li>
                        <li>dice(min, max): Random int [min, max-1].</li>
                        <li>min(a, b)/max(a, b): Min/max of numbers.</li>
                        <li>abs(x): Absolute value.</li>
                        <li>sqrt(x): Square root (non-negative).</li>
                        <li>chance(p): True with p% probability (0-100).</li>
                        <li>if(cond, true_expr, false_expr): Ternary (any type).</li>
                    </ul>
                    <li><strong>Operators</strong>: or (||), and (&&), comparisons (>=,<=,!=,==,>,<,=), math (+,-,*,/).</li>
                    <li><strong>Constants</strong>: true, false, numbers, "strings".</li>
                    <li><strong>Nesting</strong>: Parens, no quotes in funcs except strings.</li>
                    <li><strong>Errors</strong>: Division by zero, type mismatch, unknown var/state.</li>
                    <li><strong>Text Interpolation</strong>: [expr] in title/desc/context/choice text (evals to string).</li>
                </ul>
                <p>Right-click inputs: Menu with tokens + examples. Search/filter, or copy/paste/cut.</p>
                <p>Example: "if(get(health) > 50 and not(visited(danger)), get(health) + dice(1,10), 0)"</p>
                <h2>10. Advanced Features</h2>
                <h3>Multi-Language Support</h3>
                <ul>
                    <li><strong>Language</strong> menu: Switch (e.g., English to Japanese).</li>
                    <li>Translates UI. Story content remains as-is.</li>
                </ul>
                <h3>Keyboard Shortcuts</h3>
                <ul>
                    <li>Ctrl+N: New.</li>
                    <li>Ctrl+O: Load.</li>
                    <li>Ctrl+S: Save.</li>
                    <li>1-6: Tabs (1=Text, 2=Metadata, etc.).</li>
                    <li>Graph: +/- (zoom), 0 (center), Arrows (pan).</li>
                </ul>
                <h3>Error Handling</h3>
                <ul>
                    <li>Invalid expressions: Shown in Play tab (appends to desc).</li>
                    <li>Graph: "No states" if empty.</li>
                    <li>Intrinsics: LastError accumulates; clears on advance.</li>
                </ul>
                <h3>Tips</h3>
                <ul>
                    <li>Build incrementally: Metadata > Variables > States > Choices > Test in Play.</li>
                    <li>Use Graph for overview.</li>
                    <li>For complex logic, edit in Text tab.</li>
                    <li>Browser refresh: Restores from local storage.</li>
                    <li>Clear Storage: If issues, clear browser data.</li>
                    <li>Intrinsics Best Practices: Avoid deep nesting in expr (stack risk); use actions for entry logic; properties for special behaviors.</li>
                </ul>
                <h2>11. Troubleshooting</h2>
                <ul>
                    <li><strong>Blank Editor</strong>: New Story or load file.</li>
                    <li><strong>Graph Not Rendering</strong>: Check console (F12) for Mermaid errors.</li>
                    <li><strong>Play Errors</strong>: Fix in States/Variables (e.g., unknown var in expr).</li>
                    <li><strong>Slow Performance</strong>: For huge stories, edit in Text.</li>
                    <li><strong>No Backend</strong>: Ensure NSE2.js loads (Emscripten module).</li>
                    <li><strong>Intrinsic Issues</strong>: Mismatched parens/quotes in expr cause eval failures; constraints only apply on set, not initial.</li>
                </ul>
                <p>If stuck, check console or create a minimal example.</p>
                <p>This covers the NS2 Editor extensively, now with intrinsics for deeper understanding. Experiment and create! For updates, modify the HTML/JS as needed.</p>
            </div>
        </div>
    </div>
    <script>
        function copyRaw() {
            const content = document.getElementById('guide-content').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Raw text copied to clipboard!');
            });
        }

        function copyMarkdown() {
            const content = htmlToMarkdown(document.getElementById('guide-content'));
            navigator.clipboard.writeText(content).then(() => {
                alert('Markdown copied to clipboard!');
            });
        }

        function htmlToMarkdown(node, level = 0) {
            if (node.nodeType === 3) {
                return node.textContent;
            }
            if (node.nodeType !== 1) return '';
            const tag = node.tagName.toLowerCase();
            const childrenMd = Array.from(node.childNodes).map(child => htmlToMarkdown(child, level)).join('');
            switch (tag) {
                case 'h1':
                    return '# ' + childrenMd.trim() + '\n\n';
                case 'h2':
                    return '## ' + childrenMd.trim() + '\n\n';
                case 'h3':
                    return '### ' + childrenMd.trim() + '\n\n';
                case 'p':
                    return childrenMd.trim() + '\n\n';
                case 'ul':
                    return Array.from(node.querySelectorAll(':scope > li')).map(li => htmlToMarkdown(li, level)).join('') + '\n';
                case 'li':
                    let textParts = [];
                    let subUls = [];
                    node.childNodes.forEach(child => {
                        if (child.nodeType === 1 && child.tagName.toLowerCase() === 'ul') {
                            subUls.push(htmlToMarkdown(child, level + 1));
                        } else {
                            textParts.push(htmlToMarkdown(child, level).trim());
                        }
                    });
                    const indent = '  '.repeat(level);
                    return indent + '- ' + textParts.join(' ') + '\n' + subUls.join('\n');
                case 'pre':
                    return '```\n' + node.textContent + '\n```\n\n';
                case 'strong':
                    return '**' + childrenMd + '**';
                case 'em':
                    return '*' + childrenMd + '*';
                case 'code':
                    return '`' + childrenMd + '`';
                default:
                    return childrenMd;
            }
        }
    </script>
</body>
</html>