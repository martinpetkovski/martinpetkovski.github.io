<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NS2 Reader</title>
<style>
/* Book-like reader theme (sepia) */
html, body { height:100%; }
html { background:#f6f1e1; }
body {
    margin:0;
    background:#f6f1e1;
    color:#1f1a12;
    display:flex;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-family: Georgia, "Iowan Old Style", "Palatino Linotype", "Book Antiqua", "Times New Roman", Times, serif;
    box-shadow: none; /* override dark app-wide vignette */
}

/* Sepia thin scrollbars (override for reader) */
*::-webkit-scrollbar {
    width: 1px;
    height: 1px;
}
*::-webkit-scrollbar-track {
    background: transparent;
}
*::-webkit-scrollbar-thumb {
    background: rgba(90, 70, 45, 0.78); /* warm sepia tone */
    box-shadow: 0 0 6px rgba(90, 70, 45, 0.45); /* subtle glow */
}
*::-webkit-scrollbar-thumb:hover {
    box-shadow: 0 0 8px rgba(90, 70, 45, 0.6);
}
html, body, .play-content {
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: rgba(90, 70, 45, 0.78) rgba(246, 241, 225, 0.35);
}

.main {
    flex:1;
    display:flex;
    flex-direction:column;
    min-height:0;
    box-sizing:border-box;
    padding:48px 24px;
    max-width: 720px;
    margin: 0 auto;
    background:#f6f1e1;
    box-shadow: none !important;
}

.play-toolbar {
    /* Turn the top toolbar into an auto-hiding left sidebar */
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 240px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
    padding: 12px 10px;
    background: rgba(246, 241, 225, 0.92);
    border-right: 1px solid #e6e6e6;
    box-shadow: 0 4px 18px rgba(0,0,0,0.12);
    transform: translateX(calc(-100% + 12px)); /* leave a 12px sliver visible */
    transition: transform 0.2s ease;
    z-index: 1000;
}
.has-electron-titlebar .play-toolbar { top: 37px; }
.play-toolbar:hover,
.play-toolbar:focus-within {
    transform: translateX(0);
}

button {
    appearance: none;
    background: transparent;
    color: #222;
    border: 2px solid #111;
    padding: 6px 10px;
    font-size: 14px;
    cursor: pointer;
    font-weight: bold;
}
.play-toolbar button {
    /* Stack buttons vertically and make them fill the sidebar width */
    width: 100%;
    flex: 0 0 auto;
}
.play-toolbar button > span { min-width: 0; }
.play-toolbar button:hover 
{ 
    background:#111;
    color: #fff;
    transition: 0.15s;
}
/* Keep choices full-width and left-aligned within the list */
.choices button { width: 100%; text-align: left; }
/* Match toolbar hover style for choices */
.choices button:hover { background:#111; color:#fff; transition:0.15s; text-decoration:none; }

#play-title {
    font-size: 24px;
    margin-right: auto;
    color: #000 !important;
    text-shadow: none !important;
    font-weight: bolder !important;
}

.play-content {
    flex:1;
    overflow-y:auto;
    background:#f6f1e1;
    box-shadow: none !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}
.play-content h2 {
    margin: 0 0 .4em;
    font-weight: 600;
    font-size: 28px;
    letter-spacing: .01em;
}
.play-content h3 { margin: 1.5em 0 .5em; font-weight:600; color:#3a3122; }
.play-content p {
    font-size: 18px;
    line-height: 1.7;
    text-align: justify;
    text-justify: inter-word;
    hyphens: auto;
    -webkit-hyphens: auto;
    margin: 0 0 1em;
}

.play-content table { width:100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #e6e0cf; box-shadow: none; background:#fdf9ea; }
.play-content table th, .play-content table td { padding:10px 8px; border-bottom:1px solid #e6e0cf; }
.play-content table th { background:#f3ecd6; font-weight:600; color:#3a3122; text-align:left; }
.play-content input[type=text] { width:100%; box-sizing:border-box; padding:6px 8px; border:1px solid #cfc7b0; border-radius:4px; background:#fffdf4; color:#1f1a12; font: 14px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
.play-content input[type=text]:focus { outline:none; border-color:#999; box-shadow: 0 0 0 2px rgba(0,0,0,0.05); }

/* Book-like choices */
.choices {
    display:flex;
    flex-direction:column;
    gap: 6px;
    margin: 16px 0 20px;
    counter-reset: choice;
}
.choices button::before {
    counter-increment: choice;
    content: "[" counter(choice) "] ";
    color: #666;
    font-size: 0.95em;
}

.choices button:active { color:#000; }
.choices button.disabled { color:#8a8375; cursor:not-allowed; text-decoration: none; }
.choices button.disabled::before { color:#b4ab95; }
/* Variables visibility toggle */
#play-vars-section.is-collapsed { display:none; }
/* Vars toolbar styling */
.play-vars-toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.play-vars-toolbar button {
    appearance: none;
    background: #f6f6f6;
    color: #222;
    border: 1px solid #ddd;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
}
.play-vars-toolbar button:hover { background:#eee; }
</style>
</style>
<style>
/* Electron custom title bar (book style) */
.electron-titlebar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 28px;
    display: none; /* enabled dynamically only in Electron */
    align-items: center;
    gap: 10px;
    padding: 4px 8px;
    background: #efe8d2;
    border-bottom: 1px solid #e6e0cf;
    color: #1f1a12;
    -webkit-app-region: drag;
    z-index: 2000;
}
.electron-titlebar .app-icon { width: 16px; height: 16px; border-radius: 2px; -webkit-app-region: no-drag; }
.electron-titlebar .title { font-weight: 700; letter-spacing: .15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; }
.electron-titlebar .spacer { flex: 1; }
.electron-titlebar .win-btns { display: flex; gap: 4px; -webkit-app-region: no-drag; }
.electron-titlebar .win-btns button {
    width: 28px; height: 22px; border: 1px solid #cfc7b0; border-radius: 4px; background: #f6f1e1; color: #1f1a12; cursor: pointer; font-weight: 700; font-size: 12px;
}
.electron-titlebar .win-btns button:hover { background: #eadfbe; }

/* Compensate content top padding when titlebar is visible */
.has-electron-titlebar .main { padding-top: 56px; }
</style>
<script src="NSE2.js"></script>
<script>
// Inline play logic (formerly in play.js) so reader.html is fully self-contained.
(function(){
    const g = window;
    function ensureModule(){ return g.Module || null; }
    function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function normalizeForMatching(s){ if(!s) return ''; return String(s).replace(/\s+/g,' ').trim(); }
    function allocateUTF8(str){ const Module = ensureModule(); if(!Module) return 0; const size = Module.lengthBytesUTF8(str)+1; const ptr = Module._malloc(size); Module.stringToUTF8(str,ptr,size); return ptr; }
    function getLastError(engine){ const Module = ensureModule(); if(!Module || !engine) return ''; try{ const ptr = Module._GetStoryLastError(engine); const err = Module.UTF8ToString(ptr); Module._FreeString(ptr); return err; }catch(e){ return ''; } }

    g.playEngine = g.playEngine || null;
    let playAvailabilityInterval = null;

    // Removed generateNS2Content (debug/unused)

    function startPlayEngine(){ const Module = ensureModule(); if(!Module){ return; } try{
        if(g.playEngine){ if(playAvailabilityInterval){ clearInterval(playAvailabilityInterval); playAvailabilityInterval=null; } Module._DestroyEngine(g.playEngine); g.playEngine=null; }
        g.playEngine = Module._CreateEngine();
        let content = localStorage.getItem('ns2_content') || '';
        if(content){ Module.FS.writeFile('/story.ns2', content); const pathPtr = allocateUTF8('/story.ns2'); Module._LoadFromFile(g.playEngine, pathPtr); Module._free(pathPtr); }
        Module._Start(g.playEngine); updatePlay();
    }catch(e){ /* silent */ }}

    function restartStory(){ startPlayEngine(); }
    function saveProgress(){ const Module = ensureModule(); if(!Module || !g.playEngine){ return; } try{ const savePath='/save.save'; const p=allocateUTF8(savePath); Module._SaveProgress(g.playEngine,p); Module._free(p); const saveContent = Module.FS.readFile(savePath,{encoding:'utf8'}); const blob=new Blob([saveContent],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='story.save'; a.click(); URL.revokeObjectURL(url); }catch(e){ /* silent */ }}
    function loadProgress(file){ const Module = ensureModule(); if(!Module || !g.playEngine){ return; } try{ const reader = new FileReader(); reader.onload = ev => { try{ const saveContent = ev.target.result; const savePath='/save.save'; Module.FS.writeFile(savePath, saveContent); const p=allocateUTF8(savePath); Module._LoadProgress(g.playEngine,p); Module._free(p); updatePlay(); }catch(er){ /* silent */ } }; reader.readAsText(file); }catch(e){ /* silent */ }}
    function setVariableValue(name,value){ const Module = ensureModule(); if(!Module || !g.playEngine) return; const namePtr = allocateUTF8(name); const valuePtr = allocateUTF8(value); Module._SetVariableValue(g.playEngine,namePtr,valuePtr); Module._free(valuePtr); Module._free(namePtr); updatePlay(); }
    function performChoice(actionIndex){
        const Module = ensureModule();
        if(!Module || !g.playEngine) return;
        if(typeof Module._Advance !== 'function') { return; }
        try {
            Module._Advance(g.playEngine, actionIndex);
            // On success, just refresh UI silently.
            updatePlay();
        } catch(e) { /* silent */ }
    }
    function refreshPlayChoiceAvailability(){
        const Module = ensureModule();
        if(!Module || !g.playEngine) return;
        // Gather available actions (texts) into a set for quick lookup.
        const pActionsPtr = Module._malloc(4);
        const countAvailable = Module._GetAvailableActions(g.playEngine, pActionsPtr);
        const actionsArrayPtr = Module.getValue(pActionsPtr, 'i32');
        const availableSet = new Map(); // text -> first action index
        for(let ai=0; ai<countAvailable; ai++){
            const strPtr = Module.getValue(actionsArrayPtr + ai*4, 'i32');
            const txt = normalizeForMatching(Module.UTF8ToString(strPtr));
            if(!availableSet.has(txt)) availableSet.set(txt, ai);
        }
        const choicesDiv = document.getElementById('play-choices');
        if(choicesDiv){
            const totalChoices = choicesDiv.querySelectorAll('button').length;
            let idx = 0;
            [...choicesDiv.querySelectorAll('button')].forEach(btn => {
                const rawText = btn.dataset.choiceText || btn.textContent || '';
                const normText = normalizeForMatching(rawText);
                // Determine target state visitability.
                const targetPtr = Module._GetChoiceTarget(g.playEngine, idx);
                const target = Module.UTF8ToString(targetPtr);
                Module._FreeString(targetPtr);
                const targetNamePtr = allocateUTF8(target);
                const canVisit = Module._CanVisitState(g.playEngine, targetNamePtr) === 1;
                Module._free(targetNamePtr);
                const actionIdx = availableSet.has(normText) ? availableSet.get(normText) : -1;
                const enable = actionIdx >= 0 && canVisit;
                if(!enable){
                    btn.classList.add('disabled');
                    btn.disabled = true;
                    btn.title = canVisit ? 'Action not currently available' : 'Target state not visitable';
                    btn.onclick = null;
                    btn.dataset.actionIndex = '';
                } else {
                    btn.classList.remove('disabled');
                    btn.disabled = false;
                    btn.title = '';
                    btn.dataset.actionIndex = String(actionIdx);
                    btn.onclick = () => performChoice(actionIdx);
                }
                idx++;
            });
        }
        Module._FreeStrings(actionsArrayPtr, countAvailable);
        Module._free(pActionsPtr);
    }
    function filterPlayVars(){ const searchInput = document.getElementById('play-var-search'); if(!searchInput) return; const q = normalizeForMatching(searchInput.value||'').toLowerCase(); const rows = document.querySelectorAll('#play-variables tbody tr'); rows.forEach(row=>{ try{ const name=normalizeForMatching(row.cells[0].textContent||'').toLowerCase(); row.style.display = name.includes(q) ? '' : 'none'; }catch(e){ row.style.display=''; } }); }
    function toggleVariablesVisibility(){ const panel=document.getElementById('play-vars-section'); const btn=document.getElementById('toggle-vars-btn'); if(!panel||!btn) return; const collapsed = panel.classList.toggle('is-collapsed'); btn.setAttribute('aria-expanded', String(!collapsed)); btn.textContent = collapsed ? 'Show Variables' : 'Hide Variables'; }
    function updatePlay(){ const Module = ensureModule(); if(!Module || !g.playEngine){ const t=document.getElementById('play-title'); if(t) t.textContent=''; const d=document.getElementById('play-desc'); if(d) d.innerHTML='<em>Click "Start" to begin.</em>'; const c=document.getElementById('play-choices'); if(c) c.innerHTML=''; const v=document.getElementById('play-variables'); if(v) v.innerHTML=''; return; } const stateCount = Module._GetStateCount(g.playEngine); if(stateCount===0){ const t=document.getElementById('play-title'); if(t) t.textContent='No Story Loaded'; const d=document.getElementById('play-desc'); if(d) d.innerHTML='<em>Create states and set a start state.</em>'; return; }
        const titlePtr = Module._GetCurrentTitle(g.playEngine); const title = Module.UTF8ToString(titlePtr); Module._FreeString(titlePtr);
        const t=document.getElementById('play-title'); if(t) t.textContent=title;
        const descPtr = Module._GetCurrentDescription(g.playEngine); const desc = Module.UTF8ToString(descPtr); Module._FreeString(descPtr); const d=document.getElementById('play-desc'); if(d) d.textContent=desc;
        // Build Electron compact title: StoryTitle — CurrentStateName (fallbacks apply)
        try {
            const et=document.getElementById('electron-title');
            if(et){
                // Story title (global)
                let storyTitle = '';
                try { const stPtr = Module._GetStoryTitle(g.playEngine); storyTitle = Module.UTF8ToString(stPtr); Module._FreeString(stPtr); } catch(e){}
                // Current state name via matching script content (robust fallback)
                let currentStateName = '';
                try {
                    const curScriptPtr = Module._GetCurrentScript(g.playEngine);
                    const curScript = Module.UTF8ToString(curScriptPtr);
                    Module._FreeString(curScriptPtr);
                    const sc = Module._GetStateCount(g.playEngine);
                    for(let i=0;i<sc;i++){
                        const sPtr = Module._GetStateScript(g.playEngine,i);
                        const s = Module.UTF8ToString(sPtr); Module._FreeString(sPtr);
                        if(s === curScript){
                            const nmPtr = Module._GetStateName(g.playEngine,i);
                            currentStateName = Module.UTF8ToString(nmPtr); Module._FreeString(nmPtr);
                            break;
                        }
                    }
                } catch(e){}
                const left = (storyTitle && storyTitle.trim()) ? storyTitle.trim() : 'NS2 Reader';
                const right = (currentStateName && currentStateName.trim()) ? currentStateName.trim() : (title||'').trim();
                et.textContent = right ? (left + ' — ' + right) : left;
            }
        } catch(e){}
        const variablesDiv=document.getElementById('play-variables'); if(variablesDiv){ variablesDiv.innerHTML=''; const table=document.createElement('table'); table.innerHTML='<thead><tr><th>Variable</th><th>Value</th></tr></thead><tbody></tbody>'; const tbody=table.querySelector('tbody'); const count=Module._GetVariableCount(g.playEngine); for(let i=0;i<count;i++){ const namePtr=Module._GetVariableName(g.playEngine,i); const name=Module.UTF8ToString(namePtr); Module._FreeString(namePtr); const namePtrVal=allocateUTF8(name); const valuePtr=Module._GetVariableValue(g.playEngine,namePtrVal); const value=Module.UTF8ToString(valuePtr); Module._FreeString(valuePtr); Module._free(namePtrVal); const tr=document.createElement('tr'); tr.innerHTML = '<td>'+escapeHtml(name)+'</td><td><input value="'+escapeHtml(value)+'" onchange="setVariableValue(\''+escapeHtml(name)+'\', this.value)" onblur="setVariableValue(\''+escapeHtml(name)+'\', this.value)"></td>'; tbody.appendChild(tr); } variablesDiv.appendChild(table); }
        filterPlayVars();
        const choicesDiv=document.getElementById('play-choices'); if(choicesDiv){ choicesDiv.innerHTML=''; const totalChoices=Module._GetCurrentChoicesCount(g.playEngine); for(let ci=0; ci<totalChoices; ci++){ const textPtr=Module._GetChoiceText(g.playEngine,ci); const text=Module.UTF8ToString(textPtr); Module._FreeString(textPtr); const btn=document.createElement('button'); btn.textContent = text; btn.dataset.choiceText = text; choicesDiv.appendChild(btn); } }
        refreshPlayChoiceAvailability(); if(playAvailabilityInterval) clearInterval(playAvailabilityInterval); playAvailabilityInterval = setInterval(()=>{ if(!g.playEngine){ clearInterval(playAvailabilityInterval); playAvailabilityInterval=null; return; } refreshPlayChoiceAvailability(); },500); if(ensureModule()._IsEnded(g.playEngine)){ if(d) d.textContent += '\n\nThe story has ended.'; }
    }
    g.startPlayEngine = startPlayEngine;
    g.restartStory = restartStory;
    g.saveProgress = saveProgress;
    function handleLoadStory(file){ if(!file) return; const Module = ensureModule(); const reader = new FileReader(); reader.onload = ev => { try { const content = ev.target.result || ''; localStorage.setItem('ns2_content', content); if(Module){ try{ if(g.playEngine){ Module._DestroyEngine(g.playEngine); g.playEngine=null; } }catch(e){} try{ g.playEngine = Module._CreateEngine(); Module.FS.writeFile('/story.ns2', content); const p = allocateUTF8('/story.ns2'); Module._LoadFromFile(g.playEngine, p); Module._free(p); Module._Start(g.playEngine); updatePlay(); }catch(e){} } } catch(e){} }; try{ reader.readAsText(file); }catch(e){} }
    function triggerLoadStory(){ const inp=document.getElementById('load-story'); if(inp) inp.click(); }
    function handleLoadFile(file){ if(file) loadProgress(file); }
    function triggerLoad(){ const inp=document.getElementById('load-save'); if(inp) inp.click(); }
    g.handleLoadStory = handleLoadStory;
    g.triggerLoadStory = triggerLoadStory;
    g.handleLoadFile = handleLoadFile;
    g.triggerLoad = triggerLoad;
    g.updatePlay = updatePlay;
    g.filterPlayVars = filterPlayVars;
    g.toggleVariablesVisibility = toggleVariablesVisibility;
    g.refreshPlayChoiceAvailability = refreshPlayChoiceAvailability;
    g.setVariableValue = setVariableValue;
    g.performChoice = performChoice;
    function maybeAutoStart(){ if(!ensureModule() || g.__playAutoStarted) return; if(document.getElementById('play-title')){ g.__playAutoStarted = true; startPlayEngine(); }}
    let tries=0; const poll=setInterval(()=>{ tries++; maybeAutoStart(); if(g.__playAutoStarted || tries>40) clearInterval(poll); },250);

    // Message bridge for editor iframe control
    g.addEventListener('message', (ev) => {
        const data = ev && ev.data;
        if(!data || !data.type) return;
        try {
            switch(data.type) {
                case 'ns2-play': {
                    const Module = ensureModule();
                    if(!Module) return;
                    // Recreate engine
                    if(g.playEngine){ try{ Module._DestroyEngine(g.playEngine); }catch(e){} g.playEngine=null; }
                    g.playEngine = Module._CreateEngine();
                    if(data.content){
                        try {
                            Module.FS.writeFile('/story.ns2', data.content);
                            const pathPtr = allocateUTF8('/story.ns2');
                            Module._LoadFromFile(g.playEngine, pathPtr);
                            Module._free(pathPtr);
                        } catch(e){}
                    } else {
                        // fallback to localStorage
                        let content = localStorage.getItem('ns2_content') || '';
                        if(content){ Module.FS.writeFile('/story.ns2', content); const pathPtr = allocateUTF8('/story.ns2'); Module._LoadFromFile(g.playEngine, pathPtr); Module._free(pathPtr); }
                    }
                    Module._Start(g.playEngine);
                    updatePlay();
                    break;
                }
                case 'ns2-restart': {
                    restartStory();
                    break;
                }
                case 'ns2-jump': {
                    const state = data.state;
                    const Module = ensureModule();
                    if(!Module || !state) return;
                    if(!g.playEngine){ g.playEngine = Module._CreateEngine(); Module._Start(g.playEngine); }
                    try {
                        const namePtr = allocateUTF8(state);
                        const canVisit = Module._CanVisitState(g.playEngine, namePtr) === 1;
                        if(canVisit){ Module._SetCurrentState(g.playEngine, namePtr); }
                        Module._free(namePtr);
                        updatePlay();
                    } catch(e){}
                    break;
                }
                case 'ns2-forcejump': {
                    const state = data.state;
                    const Module = ensureModule();
                    if(!Module || !state) return;
                    if(!g.playEngine){ g.playEngine = Module._CreateEngine(); Module._Start(g.playEngine); }
                    try {
                        const namePtr = allocateUTF8(state);
                        Module._SetCurrentState(g.playEngine, namePtr);
                        Module._free(namePtr);
                        updatePlay();
                    } catch(e){}
                    break;
                }
            }
        } catch(e){}
    });
})();
</script>
</head>
<body>
<div class="main">
    <div class="play-toolbar">
        <button onclick="triggerLoadStory()">Story Load</button>
        <button onclick="restartStory()">Restart</button>
        <button onclick="saveProgress()" title="Save Bookmark">Save Bookmark</button>
        <button onclick="triggerLoad()" title="Load Bookmark">Load Bookmark</button>
        <button id="toggle-vars-btn" aria-controls="play-vars-section" aria-expanded="false" onclick="toggleVariablesVisibility()">Show Variables</button>
        <input type="file" id="load-story" accept=".ns2,.txt" style="display:none" onchange="handleLoadStory(this.files[0])">
        <input type="file" id="load-save" accept=".save" style="display:none" onchange="handleLoadFile(this.files[0])">
        <!-- removed choice search input -->
    </div>
    <div class="play-content">
        <h2 id="play-title"></h2>
        <p id="play-desc"></p>
        <div id="play-choices" class="choices"></div>
        <div id="play-vars-section" class="is-collapsed">
            <h3 data-i18n="variables">Variables</h3>
            <div class="play-vars-toolbar" style="margin-bottom:6px;">
                <input type="text" id="play-var-search" placeholder="Search variables..." oninput="filterPlayVars()" style="width:240px;">
            </div>
            <div id="play-variables"></div>
        </div>
    </div>
    <!-- removed play-error and status elements -->
</div>
<script>
// Lightweight language/context setup for reader standalone; shared logic in play.js
window.languages = window.languages || { en: { playEngineStarted: 'Play engine started', storyRestarted: 'Story restarted' } };
window.currentLanguage = window.currentLanguage || 'en';
// Initialize module and start engine
(async()=>{ try{ if(!window.Module){ if(typeof NSE2Module==='undefined') throw new Error('NSE2Module missing'); window.Module = await NSE2Module(); } startPlayEngine(); }catch(e){ /* silent */ } })();
// Inject Electron title bar when running under Electron
(function(){
    if(!window.electronAPI) return;
    document.documentElement.classList.add('has-electron-titlebar');
    const bar = document.createElement('div');
        bar.className = 'electron-titlebar';
        bar.innerHTML = `
                <img class="app-icon" src="icon_reader.ico" alt="icon" onerror="this.onerror=null;this.src='icon_transparent.png'" />
                <div id="electron-title" class="title">NS2 Reader</div>
                <div class="spacer"></div>
                <div class="win-btns">
                    <button id="btn-min" title="Minimize" aria-label="Minimize" tabindex="0" aria-keyshortcuts="Alt+Space, N">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="7" width="8" height="1.5" fill="#1f1a12"/></svg>
                    </button>
                    <button id="btn-max" title="Maximize" aria-label="Maximize" tabindex="0">
                        <svg id="icon-max" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="8" height="8" stroke="#1f1a12" stroke-width="1.5" fill="none"/></svg>
                    </button>
                    <button id="btn-close" title="Close" aria-label="Close" tabindex="0">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3 L9 9 M9 3 L3 9" stroke="#1f1a12" stroke-width="1.5" stroke-linecap="square"/></svg>
                    </button>
                </div>`;
    document.body.appendChild(bar);
    bar.style.display = 'flex';
        const minBtn = bar.querySelector('#btn-min');
        const maxBtn = bar.querySelector('#btn-max');
        const closeBtn = bar.querySelector('#btn-close');
        if(minBtn) minBtn.onclick = ()=> window.electronAPI.minimize && window.electronAPI.minimize();
        if(maxBtn) maxBtn.onclick = async ()=> {
            try {
                const r = await (window.electronAPI.toggleMaximize && window.electronAPI.toggleMaximize());
                if(r && typeof r.maximized === 'boolean') updateMaxIcon(r.maximized);
            } catch(e){}
        };
        if(closeBtn) closeBtn.onclick = ()=> window.electronAPI.closeWindow && window.electronAPI.closeWindow();

        function updateMaxIcon(isMax){
            const icon = bar.querySelector('#icon-max');
            if(!icon) return;
            if(isMax){
                icon.outerHTML = '<svg id="icon-max" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 4.5 H9 V10.5 H3 Z M4.5 3 H10.5 V9" stroke="#1f1a12" stroke-width="1.5" fill="none"/></svg>';
                maxBtn.title = 'Restore'; maxBtn.setAttribute('aria-label','Restore');
            } else {
                icon.outerHTML = '<svg id="icon-max" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="8" height="8" stroke="#1f1a12" stroke-width="1.5" fill="none"/></svg>';
                maxBtn.title = 'Maximize'; maxBtn.setAttribute('aria-label','Maximize');
            }
        }
        if(window.electronWindowEvents && window.electronWindowEvents.onMaximize){
            window.electronWindowEvents.onMaximize((isMax)=>{ try{ updateMaxIcon(!!isMax); }catch(e){} });
        }
})();
</script>
</body>
</html>
