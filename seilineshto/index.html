<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сè или нешто: Игра</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(180deg, #1a2a44 0%, #2e3b55 100%);
            color: #ffffff;
            max-width: 1200px;
            margin: auto;
            text-align: center;
            overflow-y: auto;
            max-height: 100vh;
        }
        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5em;
            color: #d4a017;
            text-shadow: 0 0 10px rgba(212, 160, 23, 0.5);
            margin-bottom: 20px;
        }
        #options-container {
            background: #2e2e2e;
            padding: 15px;
            border: 2px solid #d4a017;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        #options-container label {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            margin: 0 10px;
            color: #ffffff;
        }
        #options-container input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 5px;
        }
        #options-container .option-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            color: #ffffff;
            margin: 0 10px;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .toggle-label-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            color: #ffffff;
            margin-right: 10px;
        }
        .toggle-label {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2e2e2e;
            border: 2px solid #d4a017;
            border-radius: 30px;
            transition: 0.4s;
        }
        .toggle-slider:before {
            content: '';
            position: absolute;
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: #d4a017;
            border-radius: 50%;
            transition: 0.4s;
        }
        #game-mode:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        #game-mode:checked + .toggle-slider {
            background: #8b0000;
        }
        #game-mode:disabled + .toggle-slider {
            cursor: not-allowed;
            opacity: 0.6;
        }
        #game-container {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        #briefcase-container {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-right: 20px;
        }
        .briefcase {
            background: linear-gradient(145deg, #c0c0c0, #8a8a8a);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            cursor: pointer;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2em;
            color: #000000;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 2px 2px rgba(255, 255, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .briefcase::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #444;
            border-radius: 3px;
        }
        .briefcase:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.7);
        }
        .briefcase.preselected {
            border-color: #ff8c00;
            transform: scale(1.03);
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.8);
        }
        .briefcase.lost {
            animation: openBox 0.8s forwards;
        }
        .briefcase.revealing {
            background: linear-gradient(145deg, #1e3a8a, #3b82f6);
            color: #ffffff;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }
        .briefcase.revealing.high-value {
            background: linear-gradient(145deg, #8b0000, #dc2626);
        }
        .briefcase.opened.low-value {
            background: linear-gradient(145deg, #1e3a8a, #3b82f6);
            color: #ffffff;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
            cursor: default;
            box-shadow: none;
        }
        .briefcase.opened.high-value {
            background: linear-gradient(145deg, #8b0000, #dc2626);
            color: #ffffff;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
            cursor: default;
            box-shadow: none;
        }
        .briefcase.opened::before {
            background: #555;
        }
        .briefcase.selected {
            background: linear-gradient(145deg, #d4a017, #b58900);
            border-color: #ffffff;
            color: #000000;
            box-shadow: 0 0 15px rgba(212, 160, 23, 0.8);
        }
        .briefcase.selected::before {
            background: #b58900;
        }
        @keyframes openBox {
            0% { transform: scaleY(1); opacity: 1; }
            50% { transform: scaleY(0); opacity: 0.5; }
            100% { transform: scaleY(1); opacity: 1; }
        }
        @keyframes losePrize {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100vw); opacity: 0; }
        }
        #prize-board {
            flex: 1;
            background: #2e2e2e;
            padding: 20px;
            border: 2px solid #d4a017;
            border-radius: 20px;
            margin: 0 10px;
        }
        #prize-board h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2em;
            color: #d4a017;
            margin-bottom: 10px;
        }
        #prize-list {
            list-style: none;
            padding: 0;
            font-size: 1.1em;
        }
        #prize-list li {
            padding: 8px 10px;
            color: #ffffff;
            border-radius: 8px;
            margin: 2px 0;
        }
        #prize-list li.low-value {
            background: rgba(30, 58, 138, 0.8);
        }
        #prize-list li.high-value {
            background: rgba(139, 0, 0, 0.8);
        }
        #prize-list li.losing {
            animation: losePrize 0.5s forwards;
        }
        #prize-list li.revealed {
            color: #666666;
            text-decoration: line-through;
            opacity: 0.7;
        }
        #offer-container, #switch-container, #stats-container {
            margin: 20px 0;
            padding: 30px;
            background: #1a2a44;
            border: 3px solid;
            border-image: linear-gradient(45deg, #d4a017, #b58900) 1;
            border-radius: 15px;
        }
        #offer-container h3, #switch-container h3, #stats-container h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            color: #d4a017;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(212, 160, 23, 0.5);
        }
        #offer-amount {
            font-size: 2em;
            color: #ffffff;
            background: #8b0000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        #stats-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            color: #ffffff;
            text-align: left;
            line-height: 1.6;
        }
        #stats-text strong {
            color: #d4a017;
        }
        .stats-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        #lila-dialogue, #lila-dialogue-main, #lila-dialogue-switch {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            color: #ffffff;
            background: rgba(212, 160, 23, 0.4);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0 15px 0;
            border: 2px solid #d4a017;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        #lila-dialogue::after, #lila-dialogue-main::after, #lila-dialogue-switch::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 12px 0;
            border-style: solid;
            border-color: rgba(212, 160, 23, 0.4) transparent transparent transparent;
        }
        #lila-dialogue span, #lila-dialogue-main span, #lila-dialogue-switch span {
            font-weight: bold;
        }
        #game-instructions {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            color: #ffffff;
            background: #2e2e2e;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #d4a017;
            margin-top: 10px;
        }
        .button {
            padding: 12px 24px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.6em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
        }
        #deal-button, #keep-button, #clear-score-button {
            background: #8b0000;
            color: #ffffff;
        }
        #deal-button:hover, #keep-button:hover, #clear-score-button:hover {
            background: #6b0000;
        }
        #no-deal-button, #switch-button, #share-button {
            background: #d4a017;
            color: #000000;
        }
        #no-deal-button:hover, #switch-button:hover {
            background: #b58900;
        }
        #share-button {
            padding: 15px 30px;
            font-size: 1.8em;
            box-shadow: 0 0 10px rgba(212, 160, 23, 0.8);
        }
        #share-button:hover {
            background: #e8b923;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 160, 23, 1);
        }
    </style>
</head>
<body>
    <h1>Сè или нешто</h1>
    <div id="options-container">
        <div class="toggle-container">
            <label for="game-mode" class="toggle-label-text">Режим на игра: <span id="game-mode-text">Дневна</span></label>
            <label class="toggle-label">
                <input type="checkbox" id="game-mode" hidden>
                <span class="toggle-slider"></span>
            </label>
        </div>
        <label><input type="checkbox" id="lucky-charm"> Земи Амајлија</label>
        <label><input type="checkbox" id="scheme"> Земи Шема</label>
    </div>
    <div id="game-container">
        <div id="briefcase-container"></div>
        <div id="prize-board">
            <h3>Награди</h3>
            <ul id="prize-list"></ul>
        </div>
    </div>
    <div id="offer-container" style="display: none;">
        <h3>Понуда од Банкарот</h3>
        <div id="lila-dialogue"></div>
        <div id="offer-amount"></div>
        <button id="deal-button" class="button">Се согласувам</button>
        <button id="no-deal-button" class="button">Не се согласувам</button>
    </div>
    <div id="switch-container" style="display: none;">
        <h3>Смени ја кутијата?</h3>
        <div id="lila-dialogue-switch"></div>
        <button id="keep-button" class="button">Задржи ја кутијата</button>
        <button id="switch-button" class="button">Смени ја кутијата</button>
    </div>
    <div id="stats-container" style="display: none;">
        <h3>Статистики</h3>
        <p id="stats-text"></p>
        <div class="stats-buttons">
            <button id="share-button" class="button">Сподели</button>
            <button id="clear-score-button" class="button">Исчисти резултат</button>
        </div>
    </div>
    <div id="lila-dialogue-main" style="display: none;"></div>
    <div id="game-instructions">Избери ја твојата кутија!</div>

    <script>
        const prizes = [
            1, 5, 10, 20, 30, 40, 50, 100, 250, 500, 750, 1000, 2000, 3000, 4000, 5000,
            10000, 20000, 35000, 100000, 250000, 1000000
        ];
        const rounds = [6, 4, 3, 2, 2, 1, 1, 1];
        const offerMultipliers = [0.5, 0.6, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95];

        // Лила’s dialogue options
        const millionDialogue = [
            "Внимавај, можеби е милионот!",
            "Твоите пријатели мислат дека милионот е во оваа кутија!",
            "Твоето семејство верува дека ова е милионот, избери ја!"
        ];
        const boxDialogue = [
            "Оваа кутија изгледа среќна, избери ја!",
            "Чувствувам добра енергија од таа кутија!",
            "Ајде, ризикувај со оваа!",
            "Оваа кутија крие нешто големо, пробај ја!",
            "Интуицијата ми вели дека е добра, земи ја!",
            "Не размислувај многу, оваа е вистинската!",
            "Секоја кутија е авантура, избери ја оваа!",
            "Твоите пријатели во публиката велат да ја земеш оваа кутија!",
            "Твоето семејство ти дава поддршка, избери ја оваа!",
            "Публиката е возбудена, оваа кутија е хит!"
        ];
        const boxAvoidDialogue = [
            "Мислам дека има подобри кутии, пробај друга!",
            "Не сум сигурна за оваа, избери друга кутија!",
            "Чувствувам дека оваа не е вистинската, продолжи!",
            "Твоите пријатели мислат дека има подобри кутии!",
            "Твоето семејство ти сугерира да пробаш друга!"
        ];
        const acceptDialogue = [
            "Оваа понуда е супер, земи ја! Животот е краток за ризици!",
            "Ајде, Банкарот е великодушен денес, не ја пропуштај!",
            "Чувствувам дека ова е твојот момент, прифати!",
            "Не бидете алчни, ова е солидна сума!",
            "Земи ја понудата, Банкарот не дава вакви шанси секој ден!",
            "Ова е паметен потег, прифати и уживај!",
            "Пари на маса, што чекаш? Земи ја!",
            "Твоите пријатели ти викаат да ја земеш понудата!",
            "Твоето семејство мисли дека ова е добра понуда, прифати!",
            "Публиката аплаудира, земи ја оваа сума!"
        ];
        const rejectDialogue = [
            "Не се откажувај, големата награда е блиску!",
            "Милионот те чека, продолжи да играш!",
            "Има нешто големо во твојата кутија, не прифаќај!",
            "Ризикувај, верувам во твојата среќа!",
            "Милионот е зад аголот, не се предавај!",
            "Оваа понуда е мала, оди до крај!",
            "Твојата кутија вреди пове�е, продолжи!",
            "Твоите пријатели велат да продолжиш, милионот е блиску!",
            "Твоето семејство ти дава храброст, не прифаќај!",
            "Публиката те бодри, оди до крај!"
        ];
        const keepDialogue = [
            "Задржи ја кутијата, чувствувам дека е вистинската!",
            "Не менувај, оваа кутија е твојата среќа!",
            "Верувај во твојот избор, задржи ја!",
            "Твоите пријатели велат да ја задржиш кутијата!",
            "Твоето семејство ти дава поддршка, не ја менувај!"
        ];
        const switchDialogue = [
            "Смени ја кутијата, другата изгледа подобро!",
            "Ризикувај, смени ја за поголема награда!",
            "Чувствувам дека другата кутија е победник, смени ја!",
            "Твоите пријатели мислат дека треба да ја смениш кутијата!",
            "Твоето семејство ти сугерира да ја смениш, пробај!"
        ];
        const shareDialogue = [
            "Банкарот е во шок, ти си вистинска ѕвезда!",
            "Милионот беше блиску, но ти си шампион!",
            "Публиката е во транс, браво за победата!",
            "Твоите пријатели се гордеат, одлична игра!",
            "Ова е за во историјата, Лила е воодушевена!",
            "Банкарот плаче, ти си крал на играта!",
            "Сите зборуваат за твојата победа, продолжи вака!"
        ];

        let gameState = {
            boxes: [],
            selectedBox: null,
            preselectedBox: null,
            currentRound: 0,
            boxesToOpen: rounds[0],
            openedBoxes: 0,
            gameOver: false,
            lilaWrongChance: 0.8,
            gameMode: 'daily',
            newlyOpenedPrize: null
        };

        // Update wrong chance based on checkboxes
        document.getElementById('lucky-charm').addEventListener('change', updateLilaWrongChance);
        document.getElementById('scheme').addEventListener('change', updateLilaWrongChance);

        function updateLilaWrongChance() {
            const hasLuckyCharm = document.getElementById('lucky-charm').checked;
            const hasScheme = document.getElementById('scheme').checked;
            if (hasScheme) {
                gameState.lilaWrongChance = 0.25;
            } else if (hasLuckyCharm) {
                gameState.lilaWrongChance = 0.5;
            } else {
                gameState.lilaWrongChance = 0.8;
            }
        }

        function lockOptions() {
            const hasLuckyCharm = document.getElementById('lucky-charm').checked;
            const hasScheme = document.getElementById('scheme').checked;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = `
                <span class="option-text">Режим: ${gameState.gameMode === 'daily' ? 'Дневна игра' : 'Случајна игра'}</span>
                <span class="option-text">Амајлија: ${hasLuckyCharm ? 'Да' : 'Не'}</span>
                <span class="option-text">Шема: ${hasScheme ? 'Да' : 'Не'}</span>
            `;
        }

        function isMillionAvailable() {
            return gameState.boxes.some(box => box.prize === 1000000 && !box.opened);
        }

        // Seedable random number generator (Mulberry32)
        function seedableRandom(seed) {
            let t = seed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }

        // Generate daily seed
        function getDailySeed() {
            const today = new Date().toISOString().split('T')[0];
            let seed = 0;
            for (let i = 0; i < today.length; i++) {
                seed += today.charCodeAt(i);
            }
            return seed;
        }

        // Shuffle array (Fisher-Yates)
        function shuffle(array) {
            const isDaily = gameState.gameMode === 'daily';
            let rng = isDaily ? seedableRandom.bind(null, getDailySeed()) : Math.random;
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Initialize game
        function initGame() {
            gameState.gameMode = document.getElementById('game-mode').checked ? 'random' : 'daily';
            const today = new Date().toISOString().split('T')[0];
            const resultCookie = getCookie(`se_ili_neshto_result_${today}`);
            if (gameState.gameMode === 'daily' && resultCookie) {
                gameState.gameOver = true;
                document.getElementById('game-instructions').textContent = `Денес освои ${resultCookie.amount} денари! Обиди се утре или играј случајна игра.`;
                document.getElementById('briefcase-container').innerHTML = '';
                document.getElementById('prize-board').style.display = 'none';
                showStats();
                return;
            }
            gameState.boxes = shuffle([...prizes]).map((prize, index) => ({
                prize: prize,
                opened: false,
                selected: false,
                preselected: false,
                index: index + 1
            }));
            gameState.boxesToOpen = rounds[0];
            gameState.gameOver = false;
            renderBriefcases();
            renderPrizeBoard();
            document.getElementById('game-mode').disabled = false;
            document.getElementById('game-mode-text').textContent = gameState.gameMode === 'daily' ? 'Дневна' : 'Случајна';
        }

        // Render briefcases
        function renderBriefcases() {
            const container = document.getElementById('briefcase-container');
            container.innerHTML = '';
            gameState.boxes.forEach(box => {
                const div = document.createElement('div');
                div.className = 'briefcase';
                if (box.opened) {
                    div.className += ` opened ${box.prize <= 750 ? 'low-value' : 'high-value'}`;
                    div.textContent = `${box.prize} денари`;
                } else if (box.selected) {
                    div.className += ' selected';
                    div.textContent = `Твојата кутија ${box.index}`;
                } else if (box.preselected) {
                    div.className += ' preselected';
                    div.textContent = `Кутија ${box.index}`;
                } else {
                    div.textContent = `Кутија ${box.index}`;
                }
                if (!gameState.gameOver) {
                    div.addEventListener('click', () => handleBriefcaseClick(box));
                }
                container.appendChild(div);
            });
        }

        // Render prize board
        function renderPrizeBoard() {
            const list = document.getElementById('prize-list');
            list.innerHTML = '';
            prizes.sort((a, b) => a - b).forEach(prize => {
                const li = document.createElement('li');
                li.textContent = `${prize} денари`;
                li.className = prize <= 750 ? 'low-value' : 'high-value';
                if (gameState.boxes.some(box => box.prize === prize && box.opened)) {
                    if (gameState.newlyOpenedPrize === prize) {
                        li.className += ' losing';
                        setTimeout(() => {
                            li.className = `${prize <= 750 ? 'low-value' : 'high-value'} revealed`;
                        }, 500);
                    } else {
                        li.className += ' revealed';
                    }
                }
                list.appendChild(li);
            });
        }

        // Handle briefcase click
        function handleBriefcaseClick(box) {
            if (gameState.gameOver || box.opened || box.selected) return;

            const lilaDialogueMain = document.getElementById('lila-dialogue-main');
            const gameInstructions = document.getElementById('game-instructions');

            if (!gameState.selectedBox) {
                box.selected = true;
                gameState.selectedBox = box;
                lockOptions();
                lilaDialogueMain.style.display = 'none';
                gameInstructions.textContent = `Отвори ${gameState.boxesToOpen} кутии за рунда ${gameState.currentRound + 1}!`;
                renderBriefcases();
                document.getElementById('game-mode').disabled = true;
            } else if (gameState.openedBoxes < gameState.boxesToOpen) {
                if (gameState.preselectedBox === box) {
                    const briefcaseElement = document.querySelector(`.briefcase.preselected`);
                    if (briefcaseElement) {
                        gameState.newlyOpenedPrize = box.prize;
                        briefcaseElement.classList.add('lost');
                        setTimeout(() => {
                            briefcaseElement.classList.remove('lost');
                            briefcaseElement.classList.add('revealing', box.prize <= 750 ? 'low-value' : 'high-value');
                            briefcaseElement.textContent = `${box.prize} денари`;
                        }, 400);
                        setTimeout(() => {
                            box.opened = true;
                            box.preselected = false;
                            gameState.preselectedBox = null;
                            gameState.openedBoxes++;
                            lilaDialogueMain.style.display = 'none';
                            gameInstructions.textContent = `Отвори уште ${gameState.boxesToOpen - gameState.openedBoxes} кутии за рунда ${gameState.currentRound + 1}!`;
                            briefcaseElement.classList.remove('revealing');
                            briefcaseElement.classList.add('opened');
                            renderBriefcases();
                            renderPrizeBoard();
                            gameState.newlyOpenedPrize = null;

                            if (gameState.openedBoxes === gameState.boxesToOpen) {
                                showBankerOffer();
                            }
                        }, 800);
                    }
                } else {
                    if (gameState.preselectedBox) {
                        gameState.preselectedBox.preselected = false;
                    }
                    box.preselected = true;
                    gameState.preselectedBox = box;

                    const isHighValue = box.prize >= 100000;
                    const rightAdvice = isHighValue ? 'choose' : 'avoid';
                    const wrongAdvice = isHighValue ? 'avoid' : 'choose';
                    const isWrongAdvice = Math.random() < gameState.lilaWrongChance;
                    const advice = isWrongAdvice ? wrongAdvice : rightAdvice;
                    const useAudience = Math.random() < 0.3;
                    const audienceType = Math.random() < 0.5 ? 'пријатели' : 'семејство';
                    let dialogue;
                    if (advice === 'choose') {
                        let dialoguePool = boxDialogue.filter(d => !d.includes('пријатели') && !d.includes('семејство') && !d.includes('публиката'));
                        if (isMillionAvailable()) {
                            dialoguePool = dialoguePool.concat(millionDialogue.filter(d => !d.includes('пријатели') && !d.includes('семејство')));
                        }
                        if (useAudience) {
                            let audiencePool = boxDialogue.filter(d => d.includes(audienceType) || d.includes('публиката'));
                            if (isMillionAvailable()) {
                                audiencePool = audiencePool.concat(millionDialogue.filter(d => d.includes(audienceType)));
                            }
                            dialogue = audiencePool.length > 0 ? audiencePool[Math.floor(Math.random() * audiencePool.length)] : dialoguePool[Math.floor(Math.random() * dialoguePool.length)];
                        } else {
                            dialogue = dialoguePool.length > 0 ? dialoguePool[Math.floor(Math.random() * dialoguePool.length)] : "Оваа кутија изгледа интересно!";
                        }
                    } else {
                        let dialoguePool = boxAvoidDialogue.filter(d => !d.includes('пријатели') && !d.includes('семејство'));
                        if (useAudience) {
                            let audiencePool = boxAvoidDialogue.filter(d => d.includes(audienceType));
                            dialogue = audiencePool.length > 0 ? audiencePool[Math.floor(Math.random() * audiencePool.length)] : dialoguePool[Math.floor(Math.random() * dialoguePool.length)];
                        } else {
                            dialogue = dialoguePool.length > 0 ? dialoguePool[Math.floor(Math.random() * dialoguePool.length)] : "Мислам че има подобри кутии!";
                        }
                    }
                    lilaDialogueMain.style.display = 'block';
                    lilaDialogueMain.innerHTML = `<span>Лила вели:</span> "${dialogue}"`;
                    gameInstructions.textContent = `Кликни повторно за да ја отвориш кутијата!`;
                    renderBriefcases();
                }
            }
        }

        // Calculate expected value
        function calculateExpectedValue() {
            const remainingPrizes = gameState.boxes.filter(box => !box.opened).map(box => box.prize);
            return remainingPrizes.reduce((sum, prize) => sum + prize, 0) / remainingPrizes.length;
        }

        // Show banker’s offer and Лила’s advice
        function showBankerOffer() {
            const expectedValue = calculateExpectedValue();
            const offer = Math.round(expectedValue * offerMultipliers[gameState.currentRound]);
            const offerContainer = document.getElementById('offer-container');
            document.getElementById('offer-amount').textContent = `${offer} денари`;

            const isGoodOffer = offer >= expectedValue;
            const rightChoice = isGoodOffer ? 'accept' : 'reject';
            const wrongChoice = isGoodOffer ? 'reject' : 'accept';
            const isWrongAdvice = Math.random() < gameState.lilaWrongChance;
            const adviceChoice = isWrongAdvice ? wrongChoice : rightChoice;
            const useAudience = Math.random() < 0.3;
            const audienceType = Math.random() < 0.5 ? 'пријатели' : 'семејство';
            let dialogue;
            if (useAudience) {
                let audiencePool = (adviceChoice === 'accept' ? acceptDialogue : rejectDialogue)
                    .filter(d => d.includes(audienceType) || d.includes('публиката'));
                dialogue = audiencePool.length > 0 ? audiencePool[Math.floor(Math.random() * audiencePool.length)] : "Размисли добро!";
            } else {
                let dialoguePool = (adviceChoice === 'accept' ? acceptDialogue : rejectDialogue)
                    .filter(d => !d.includes('пријатели') && !d.includes('семејство') && !d.includes('публиката'));
                dialogue = dialoguePool.length > 0 ? dialoguePool[Math.floor(Math.random() * dialoguePool.length)] : "Размисли добро!";
            }
            document.getElementById('lila-dialogue').innerHTML = `<span>Лила вели:</span> "${dialogue}"`;

            offerContainer.style.display = 'block';
            document.getElementById('lila-dialogue-main').style.display = 'none';
            document.getElementById('game-instructions').textContent = '';
        }

        // Handle offer decision
        function handleOfferDecision(accepted) {
            const gameInstructions = document.getElementById('game-instructions');
            if (accepted) {
                const offer = parseInt(document.getElementById('offer-amount').textContent);
                gameState.gameOver = true;
                gameInstructions.textContent = `Се согласи! Освои ${offer} денари! Твојата кутија имаше ${gameState.selectedBox.prize} денари.`;
                document.getElementById('offer-container').style.display = 'none';
                saveGameResult(offer);
                showStats();
            } else {
                if (gameState.currentRound === rounds.length - 1) {
                    showSwitchOption();
                } else {
                    gameState.currentRound++;
                    gameState.boxesToOpen = rounds[gameState.currentRound];
                    gameState.openedBoxes = 0;
                    document.getElementById('offer-container').style.display = 'none';
                    document.getElementById('lila-dialogue-main').style.display = 'none';
                    gameInstructions.textContent = `Отвори ${gameState.boxesToOpen} кутии за рунда ${gameState.currentRound + 1}!`;
                }
            }
            renderBriefcases();
        }

        // Show switch option
        function showSwitchOption() {
            const switchContainer = document.getElementById('switch-container');
            const lilaDialogueSwitch = document.getElementById('lila-dialogue-switch');
            const unopenedBoxes = gameState.boxes.filter(box => !box.opened && !box.selected);
            const otherBox = unopenedBoxes.length > 0 ? unopenedBoxes[0] : null;

            if (!otherBox) {
                endGame(false);
                return;
            }

            const isKeepBetter = gameState.selectedBox.prize >= otherBox.prize;
            const rightChoice = isKeepBetter ? 'keep' : 'switch';
            const wrongChoice = isKeepBetter ? 'switch' : 'keep';
            const isWrongAdvice = Math.random() < gameState.lilaWrongChance;
            const adviceChoice = isWrongAdvice ? wrongChoice : rightChoice;
            const useAudience = Math.random() < 0.3;
            const audienceType = Math.random() < 0.5 ? 'пријатели' : 'семејство';
            let dialogue;
            if (useAudience) {
                let audiencePool = (adviceChoice === 'keep' ? keepDialogue : switchDialogue)
                    .filter(d => d.includes(audienceType));
                dialogue = audiencePool.length > 0 ? audiencePool[Math.floor(Math.random() * audiencePool.length)] : "Размисли добро за твојот избор!";
            } else {
                let dialoguePool = (adviceChoice === 'keep' ? keepDialogue : switchDialogue)
                    .filter(d => !d.includes('пријатели') && !d.includes('семејство'));
                dialogue = dialoguePool.length > 0 ? dialoguePool[Math.floor(Math.random() * dialoguePool.length)] : "Размисли добро за твојот избор!";
            }
            lilaDialogueSwitch.innerHTML = `<span>Лила вели:</span> "${dialogue}"`;

            switchContainer.style.display = 'block';
            document.getElementById('offer-container').style.display = 'none';
            document.getElementById('lila-dialogue-main').style.display = 'none';
            document.getElementById('game-instructions').textContent = 'Дали сакаш да ја задржиш твојата кутија или да ја смениш?';
        }

        // Handle switch decision
        function handleSwitchDecision(keep) {
            const gameInstructions = document.getElementById('game-instructions');
            const unopenedBoxes = gameState.boxes.filter(box => !box.opened && !box.selected);
            const otherBox = unopenedBoxes.length > 0 ? unopenedBoxes[0] : null;

            if (!otherBox) {
                endGame(false);
                return;
            }

            gameState.gameOver = true;
            document.getElementById('switch-container').style.display = 'none';

            let finalPrize;
            if (keep) {
                finalPrize = gameState.selectedBox.prize;
                gameInstructions.textContent = `Задржа кутијата и освои ${finalPrize} денари! Другата кутија имаше ${otherBox.prize} денари.`;
            } else {
                finalPrize = otherBox.prize;
                otherBox.selected = true;
                gameState.selectedBox.selected = false;
                gameState.selectedBox = otherBox;
                gameInstructions.textContent = `Смени кутијата и освои ${finalPrize} денари! Твојата кутија имаше ${gameState.selectedBox.prize} денари.`;
            }
            saveGameResult(finalPrize);
            showStats();
            renderBriefcases();
        }

        // End game
        function endGame(keep) {
            const gameInstructions = document.getElementById('game-instructions');
            const unopenedBoxes = gameState.boxes.filter(box => !box.opened && !box.selected);
            const finalPrize = unopenedBoxes.length > 0 ? unopenedBoxes[0].prize : 'непознат';
            gameState.gameOver = true;
            gameInstructions.textContent = `Отиде до крај! Освои ${gameState.selectedBox.prize} денари! (Другата кутија имаше ${finalPrize} денари.)`;
            document.getElementById('offer-container').style.display = 'none';
            document.getElementById('switch-container').style.display = 'none';
            saveGameResult(gameState.selectedBox.prize);
            showStats();
            renderBriefcases();
        }

        // Cookie functions
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)));
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999;';
        }

        // Save game result
        function saveGameResult(amount) {
            if (gameState.gameMode === 'daily') {
                const today = new Date().toISOString().split('T')[0];
                setCookie(`se_ili_neshto_result_${today}`, {
                    amount: amount,
                    timestamp: new Date().toISOString()
                }, 1);
            }
            let stats = getCookie('se_ili_neshto_stats') || {
                gamesPlayed: 0,
                totalWinnings: 0,
                highestWin: 0,
                winDistribution: {
                    '0-1000': 0,
                    '1001-10000': 0,
                    '10001-100000': 0,
                    '100001-250000': 0,
                    '250001-1000000': 0
                }
            };
            stats.gamesPlayed++;
            stats.totalWinnings += amount;
            stats.highestWin = Math.max(stats.highestWin, amount);
            if (amount <= 1000) stats.winDistribution['0-1000']++;
            else if (amount <= 10000) stats.winDistribution['1001-10000']++;
            else if (amount <= 100000) stats.winDistribution['10001-100000']++;
            else if (amount <= 250000) stats.winDistribution['100001-250000']++;
            else stats.winDistribution['250001-1000000']++;
            setCookie('se_ili_neshto_stats', stats, 365);
        }

        // Clear score and reset game
        function clearScoreAndReset() {
            deleteCookie('se_ili_neshto_stats');
            const today = new Date().toISOString().split('T')[0];
            deleteCookie(`se_ili_neshto_result_${today}`);
            initGame();
            document.getElementById('stats-container').style.display = 'none';
            document.getElementById('game-instructions').textContent = 'Избери ја твојата кутија!';
            document.getElementById('game-mode').disabled = false;
        }

        // Show statistics
        function showStats() {
            const statsContainer = document.getElementById('stats-container');
            const statsText = document.getElementById('stats-text');
            const stats = getCookie('se_ili_neshto_stats') || {
                gamesPlayed: 0,
                totalWinnings: 0,
                highestWin: 0,
                winDistribution: {
                    '0-1000': 0,
                    '1001-10000': 0,
                    '10001-100000': 0,
                    '100001-250000': 0,
                    '250001-1000000': 0
                }
            };
            const averageWinnings = stats.gamesPlayed > 0 ? (stats.totalWinnings / stats.gamesPlayed).toFixed(2) : 0;
            statsText.innerHTML = `
                <strong>Играни игри:</strong> ${stats.gamesPlayed}<br>
                <strong>Вкупно освоено:</strong> ${stats.totalWinnings} денари<br>
                <strong>Просечно освоено:</strong> ${averageWinnings} денари<br>
                <strong>Највисока победа:</strong> ${stats.highestWin} денари<br>
                <strong>Распределба на победи:</strong><br>
                0-1000 денари: ${stats.winDistribution['0-1000']} игри<br>
                1001-10000 денари: ${stats.winDistribution['1001-10000']} игри<br>
                10001-100000 денари: ${stats.winDistribution['10001-100000']} игри<br>
                100001-250000 денари: ${stats.winDistribution['100001-250000']} игри<br>
                250001-1000000 денари: ${stats.winDistribution['250001-1000000']} игри
            `;
            statsContainer.style.display = 'block';
        }

        // Share result
        function shareResult(amount) {
            const message = shareDialogue[Math.floor(Math.random() * shareDialogue.length)];
            const text = `Освоив ${amount} денари во Сè или нешто! Лила вели: "${message}" 🎉 Играј на https://www.najjak.com/seilineshto/ #СеИлиНешто`;
            navigator.clipboard.writeText(text).then(() => {
                alert("Резултатот е копиран!");
            }).catch(() => {
                alert("Не успеав да го копирам резултатот. Обиди се рачно!");
            });
        }

        // Initialize game
        initGame();

        // Event listeners for buttons
        document.getElementById('deal-button').addEventListener('click', () => handleOfferDecision(true));
        document.getElementById('no-deal-button').addEventListener('click', () => handleOfferDecision(false));
        document.getElementById('keep-button').addEventListener('click', () => handleSwitchDecision(true));
        document.getElementById('switch-button').addEventListener('click', () => handleSwitchDecision(false));
        document.getElementById('share-button').addEventListener('click', () => {
            const amount = parseInt(document.getElementById('game-instructions').textContent.match(/Освои (\d+)/)?.[1]) || 0;
            shareResult(amount);
        });
        document.getElementById('game-mode').addEventListener('change', () => {
            if (!gameState.selectedBox) {
                initGame();
            }
            document.getElementById('game-mode-text').textContent = document.getElementById('game-mode').checked ? 'Случајна' : 'Дневна';
        });
        document.getElementById('clear-score-button').addEventListener('click', clearScoreAndReset);
    </script>
</body>
</html>